<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TerranoKidsFind - S√©curit√© Familiale</title>
    <meta name="description" content="Application de s√©curit√© familiale pour prot√©ger et suivre vos enfants en temps r√©el">
    <meta name="theme-color" content="#FF6B35">
    <link rel="icon" href="/public/favicon.png">
    <title>TerranoKidsFind - S√©curit√© Familiale</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
    <style id="pulse-animation">
        @keyframes pulse-wave {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(2);
                opacity: 0.4;
            }
            100% {
                transform: scale(3);
                opacity: 0;
            }
        }
        
        .user-location-pulse {
            position: absolute;
            top: 0;
            left: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0, 123, 255, 0.3);
            border: 2px solid #007bff;
            animation: pulse-wave 2s infinite;
            pointer-events: none;
            z-index: 1;
        }
        
        .user-marker-container {
            position: relative;
            width: 32px;
            height: 32px;
        }
        
        .child-location-pulse {
            position: absolute;
            top: 0;
            left: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 107, 53, 0.3);
            border: 2px solid #FF6B35;
            animation: pulse-wave 2s infinite;
            pointer-events: none;
            z-index: 1;
        }
        
        .child-marker-container {
            position: relative;
            width: 40px;
            height: 40px;
        }
        
        .emergency-alert-pulse {
            position: absolute;
            top: -5px;
            left: -5px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(220, 53, 69, 0.3);
            border: 3px solid #dc3545;
            animation: emergency-pulse 1.5s infinite;
            pointer-events: none;
            z-index: 1;
        }
        
        @keyframes emergency-pulse {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        .emergency-marker {
            position: relative;
            width: 50px;
            height: 50px;
        }
        
        .accuracy-circle {
            border: 2px dashed #007bff;
            background: rgba(0, 123, 255, 0.1);
            border-radius: 50%;
        }
    </style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #FF6B35;
            --secondary: #FF8C42;
            --dark: #1A1A1A;
            --gray-800: #2C2C2C;
            --gray-600: #757575;
            --gray-300: #E0E0E0;
            --white: #FFFFFF;
            --success: #4CAF50;
            --error: #F44336;
            --warning: #FF9800;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--white);
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .nav-menu {
            display: flex;
            gap: 2rem;
            list-style: none;
        }
        
        .nav-menu a {
            color: white;
            text-decoration: none;
            transition: opacity 0.3s;
        }
        
        .nav-menu a:hover {
            opacity: 0.8;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--white);
            border-right: 1px solid var(--gray-300);
            padding: 2rem 0;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 0.5rem;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 2rem;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: linear-gradient(90deg, var(--primary), transparent);
            color: var(--primary);
            border-right: 3px solid var(--primary);
        }
        
        /* Content Area */
        .content {
            flex: 1;
            padding: 2rem;
            background: #f8f9fa;
        }
        
        .page-title {
            font-size: 2rem;
            margin-bottom: 2rem;
            color: var(--dark);
        }
        
        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .card-icon {
            width: 48px;
            height: 48px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        /* Status Cards */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .status-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .status-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .status-label {
            color: var(--gray-600);
            font-size: 0.9rem;
        }
        
        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #E55A2B;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--gray-300);
            color: var(--dark);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--error);
            color: white;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Maps */
        .map-container {
            height: 400px;
            background: var(--gray-300);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            font-size: 1.2rem;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .content {
                order: 1;
            }
            
            .nav-menu {
                display: none;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Dark Mode */
        .dark-mode {
            background: var(--dark);
            color: white;
        }
        
        .dark-mode .sidebar {
            background: var(--gray-800);
            border-color: var(--gray-600);
        }
        
        .dark-mode .content {
            background: var(--dark);
        }
        
        .dark-mode .card {
            background: var(--gray-800);
        }
        
        .dark-mode .status-card {
            background: var(--gray-800);
        }
        
        /* Performance optimizations */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Image optimization */
        img {
            max-width: 100%;
            height: auto;
        }
        
        /* Optimize animations */
        * {
            will-change: auto;
        }
        
        .pulse-marker {
            will-change: transform, opacity;
        }
        
        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header">
                <div class="logo">
                    <img src="https://res.cloudinary.com/dxy0fiahv/image/upload/v1756139122/logo_tfinds_laf9do.png" alt="TerranoKidsFind Logo" style="width: 32px; height: 32px; margin-right: 0.5rem; border-radius: 4px;">
                    TerranoKidsFind
                </div>
                <nav>
                    <ul class="nav-menu">
                        <li><a href="#dashboard" onclick="showPage('dashboard')">Tableau de bord</a></li>
                        <li><a href="#map" onclick="showPage('map')">Carte</a></li>
                        <li><a href="#messages" onclick="showPage('messages')">Messages</a></li>
                        <li><a href="#settings" onclick="showPage('settings')">Param√®tres</a></li>
                        <li><button class="btn btn-secondary" onclick="toggleTheme()"><i class="fas fa-moon"></i></button></li>
                    </ul>
                </nav>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar" role="navigation" aria-label="Menu principal">
                <ul class="sidebar-menu" role="menubar">
                    <li role="none"><a href="#dashboard" class="active nav-link" onclick="showPage('dashboard')" role="menuitem" aria-label="Aller au tableau de bord"><i class="fas fa-home" aria-hidden="true"></i> Tableau de bord</a></li>
                    <li role="none"><a href="#map" class="nav-link" onclick="showPage('map')" role="menuitem" aria-label="Aller √† la localisation"><i class="fas fa-map-marked-alt" aria-hidden="true"></i> Localisation</a></li>
                    <li role="none"><a href="#messages" class="nav-link" onclick="showPage('messages')" role="menuitem" aria-label="Aller aux messages"><i class="fas fa-comments" aria-hidden="true"></i> Messages</a></li>
                    <li role="none"><a href="#settings" class="nav-link" onclick="showPage('settings')" role="menuitem" aria-label="Aller aux param√®tres"><i class="fas fa-cog" aria-hidden="true"></i> Param√®tres</a></li>
                    <li role="none"><a href="#alerts" class="nav-link" onclick="showPage('alerts')" role="menuitem" aria-label="Aller aux alertes SOS"><i class="fas fa-exclamation-triangle" aria-hidden="true"></i> Alertes SOS</a></li>
                    <li role="none"><a href="#zones" class="nav-link" onclick="showPage('zones')" role="menuitem" aria-label="Aller aux zones s√ªres"><i class="fas fa-shield-alt" aria-hidden="true"></i> Zones S√ªres</a></li>
                    <li role="none"><a href="#contacts" class="nav-link" onclick="showPage('contacts')" role="menuitem" aria-label="Aller aux contacts"><i class="fas fa-address-book" aria-hidden="true"></i> Contacts</a></li>
                    <li role="none"><a href="#premium" class="nav-link" onclick="showPage('premium')" role="menuitem" aria-label="Aller √† Premium"><i class="fas fa-crown" aria-hidden="true"></i> Premium</a></li>
                </ul>
            </aside>

            <!-- Content Area -->
            <section class="content">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page fade-in">
                    <h1 class="page-title">Tableau de bord</h1>
                    
                    <!-- Status Cards -->
                    <div class="status-grid">
                        <div class="status-card">
                            <div class="status-value">3</div>
                            <div class="status-label">Enfants connect√©s</div>
                        </div>
                        <div class="status-card">
                            <div class="status-value">2</div>
                            <div class="status-label">Zones s√ªres</div>
                        </div>
                        <div class="status-card">
                            <div class="status-value">0</div>
                            <div class="status-label">Alertes actives</div>
                        </div>
                        <div class="status-card">
                            <div class="status-value">85%</div>
                            <div class="status-label">Batterie moyenne</div>
                        </div>
                    </div>

                    <!-- Dashboard Cards -->
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Localisation en temps r√©el</h3>
                                <div class="card-icon"><i class="fas fa-map-marker-alt"></i></div>
                            </div>
                            <p>Suivez la position de vos enfants en temps r√©el avec une pr√©cision GPS avanc√©e.</p>
                            <button class="btn btn-primary" onclick="showPage('map')">Voir la carte</button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Alertes SOS</h3>
                                <div class="card-icon"><i class="fas fa-exclamation-triangle"></i></div>
                            </div>
                            <p>Syst√®me d'alerte d'urgence instantan√© pour la s√©curit√© de vos enfants.</p>
                            <button class="btn btn-danger pulse" onclick="showPage('alerts')">Alerte SOS</button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Zones de s√©curit√©</h3>
                                <div class="card-icon"><i class="fas fa-shield-alt"></i></div>
                            </div>
                            <p>D√©finissez des zones s√ªres et recevez des notifications d'entr√©e/sortie.</p>
                            <button class="btn btn-success" onclick="showPage('zones')">G√©rer les zones</button>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Communication</h3>
                                <div class="card-icon"><i class="fas fa-comments"></i></div>
                            </div>
                            <p>Messages s√©curis√©s et appels d'urgence avec vos enfants.</p>
                            <button class="btn btn-primary" onclick="showPage('messages')">Envoyer message</button>
                        </div>
                    </div>
                </div>

                <!-- Map Page -->
                <div id="map-page" class="page" style="display: none;">
                    <h1 class="page-title"><i class="fas fa-map-marked-alt"></i> Carte de Localisation</h1>
                    
                    <!-- Map Controls -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <div class="card-header">
                            <h3 class="card-title">Contr√¥les de la Carte</h3>
                        </div>
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="centerMap()">
                                <i class="fas fa-crosshairs"></i> Centrer sur les enfants
                            </button>
                            <button class="btn btn-secondary" onclick="toggleTraffic()">
                                <i class="fas fa-road"></i> Trafic
                            </button>
                            <button class="btn btn-success" onclick="toggleZones()">
                                <i class="fas fa-shield-alt"></i> Zones s√ªres
                            </button>
                            <select class="form-input" style="width: auto;" onchange="changeMapType(this.value)">
                                <option value="roadmap">Plan</option>
                                <option value="satellite">Satellite</option>
                                <option value="hybrid">Hybride</option>
                                <option value="terrain">Terrain</option>
                            </select>
                            <button class="btn btn-warning" onclick="refreshLocations()">
                                <i class="fas fa-sync-alt"></i> Actualiser
                            </button>
                        </div>
                    </div>

                    <!-- Interactive Map -->
                    <div class="dashboard-grid">
                        <div class="card" style="grid-column: 1 / -1;">
                            <div class="card-header">
                                <h3 class="card-title">Localisation Temps R√©el</h3>
                                <span style="background: var(--success); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem;">
                                    <i class="fas fa-circle" style="animation: pulse 2s infinite;"></i> En direct
                                </span>
                            </div>
                            <div id="interactive-map" style="height: 500px; border-radius: 8px; position: relative; overflow: hidden; border: 2px solid var(--gray-200);">
                                <!-- Map Legend -->
                                <div style="position: absolute; top: 10px; left: 10px; background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 1000;">
                                    <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">L√©gende</h4>
                                    <div style="display: flex; flex-direction: column; gap: 0.3rem; font-size: 0.8rem;">
                                        <div><i class="fas fa-circle" style="color: var(--primary);"></i> Emma (√âcole)</div>
                                        <div><i class="fas fa-circle" style="color: var(--success);"></i> Lucas (Maison)</div>
                                        <div><i class="fas fa-circle" style="color: var(--info);"></i> Sarah (Grand-m√®re)</div>
                                        <div><i class="fas fa-shield-alt" style="color: var(--warning);"></i> Zones s√ªres</div>
                                    </div>
                                </div>

                                <!-- Map Controls -->
                                <div style="position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 0.5rem; z-index: 1000;">
                                    <button class="btn btn-secondary" style="padding: 0.5rem; width: 40px; height: 40px;" onclick="changeMapLayer('satellite')" title="Vue satellite">
                                        <i class="fas fa-satellite"></i>
                                    </button>
                                    <button class="btn btn-secondary" style="padding: 0.5rem; width: 40px; height: 40px;" onclick="changeMapLayer('streets')" title="Vue plan">
                                        <i class="fas fa-map"></i>
                                    </button>
                                    <button id="traffic-btn" class="btn btn-warning" style="padding: 0.5rem; width: 40px; height: 40px;" onclick="toggleTraffic()" title="Trafic">
                                        <i class="fas fa-car"></i>
                                    </button>
                                    <button class="btn btn-info" style="padding: 0.5rem; width: 40px; height: 40px;" onclick="centerOnUser()" title="Ma position">
                                        <i class="fas fa-location-arrow"></i>
                                    </button>
                                    <button class="btn btn-primary" style="padding: 0.5rem; width: 40px; height: 40px;" onclick="centerOnChildren()" title="Centrer sur enfants">
                                        <i class="fas fa-users"></i>
                                    </button>
                                    <button class="btn btn-success" style="padding: 0.5rem; width: 40px; height: 40px;" onclick="toggleSafeZones()" title="Zones s√ªres">
                                        <i class="fas fa-shield-alt"></i>
                                    </button>
                                </div>

                                <!-- Map Location Info -->
                                <div id="map-location-info" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; z-index: 1000;">
                                    <i class="fas fa-map-marker-alt"></i> <span id="location-text">Chargement de la carte...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Child Status Cards -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Emma</h3>
                                <span style="background: var(--primary); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem;">√Ä l'√©cole</span>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Batterie:</span>
                                    <span style="color: var(--success); font-weight: bold;">87%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Signal GPS:</span>
                                    <span style="color: var(--success); font-weight: bold;">Excellent</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Derni√®re position:</span>
                                    <span style="color: var(--gray-600);">Il y a 1 min</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Vitesse:</span>
                                    <span style="color: var(--info);">0 km/h</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary" style="flex: 1; padding: 0.5rem;" onclick="trackChild('emma')">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                                <button class="btn btn-secondary" style="flex: 1; padding: 0.5rem;" onclick="messageChild('emma')">
                                    <i class="fas fa-comment"></i>
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Lucas</h3>
                                <span style="background: var(--success); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem;">√Ä la maison</span>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Batterie:</span>
                                    <span style="color: var(--warning); font-weight: bold;">34%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Signal GPS:</span>
                                    <span style="color: var(--success); font-weight: bold;">Bon</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Derni√®re position:</span>
                                    <span style="color: var(--gray-600);">Il y a 3 min</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Vitesse:</span>
                                    <span style="color: var(--info);">0 km/h</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary" style="flex: 1; padding: 0.5rem;" onclick="trackChild('lucas')">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                                <button class="btn btn-secondary" style="flex: 1; padding: 0.5rem;" onclick="messageChild('lucas')">
                                    <i class="fas fa-comment"></i>
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Sarah</h3>
                                <span style="background: var(--info); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem;">Chez Grand-m√®re</span>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Batterie:</span>
                                    <span style="color: var(--success); font-weight: bold;">92%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Signal GPS:</span>
                                    <span style="color: var(--warning); font-weight: bold;">Moyen</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Derni√®re position:</span>
                                    <span style="color: var(--gray-600);">Il y a 5 min</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Vitesse:</span>
                                    <span style="color: var(--info);">0 km/h</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary" style="flex: 1; padding: 0.5rem;" onclick="trackChild('sarah')">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                                <button class="btn btn-secondary" style="flex: 1; padding: 0.5rem;" onclick="messageChild('sarah')">
                                    <i class="fas fa-comment"></i>
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="card-title">Historique des D√©placements</h3>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; padding: 0.8rem; background: var(--gray-50); border-radius: 6px; margin-bottom: 0.5rem;">
                                    <div style="width: 30px; height: 30px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem; font-size: 0.8rem; font-weight: bold;">E</div>
                                    <div style="flex: 1;">
                                        <strong>Emma est arriv√©e √† l'√©cole</strong>
                                        <div style="font-size: 0.8rem; color: var(--gray-600);">08:15 - √âcole Primaire Terrano</div>
                                    </div>
                                    <i class="fas fa-school" style="color: var(--primary);"></i>
                                </div>
                                <div style="display: flex; align-items: center; padding: 0.8rem; background: var(--gray-50); border-radius: 6px; margin-bottom: 0.5rem;">
                                    <div style="width: 30px; height: 30px; background: var(--info); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem; font-size: 0.8rem; font-weight: bold;">S</div>
                                    <div style="flex: 1;">
                                        <strong>Sarah chez Grand-m√®re</strong>
                                        <div style="font-size: 0.8rem; color: var(--gray-600);">14:30 - Rue du Bonheur</div>
                                    </div>
                                    <i class="fas fa-heart" style="color: var(--info);"></i>
                                </div>
                                <div style="display: flex; align-items: center; padding: 0.8rem; background: var(--gray-50); border-radius: 6px;">
                                    <div style="width: 30px; height: 30px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem; font-size: 0.8rem; font-weight: bold;">L</div>
                                    <div style="flex: 1;">
                                        <strong>Lucas rentr√© √† la maison</strong>
                                        <div style="font-size: 0.8rem; color: var(--gray-600);">16:45 - Rue des Lilas</div>
                                    </div>
                                    <i class="fas fa-home" style="color: var(--success);"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages Page -->
                <div id="messages-page" class="page" style="display: none;">
                    <h1 class="page-title"><i class="fas fa-comments"></i> Messages Familiaux</h1>
                    
                    <div class="card">
                        <!-- Message History -->
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="margin-bottom: 1rem;">üí¨ Historique des Messages</h3>
                            <div id="message-history" style="height: 300px; overflow-y: auto; padding: 1rem; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--gray-200);">
                                <!-- Messages will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Quick Messages -->
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 0.5rem;">Messages Rapides</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                <button class="btn btn-success" onclick="sendQuickMessage('safe')" style="padding: 0.5rem; font-size: 0.9rem;">
                                    üëç Tout va bien
                                </button>
                                <button class="btn btn-info" onclick="sendQuickMessage('arrived')" style="padding: 0.5rem; font-size: 0.9rem;">
                                    ‚úÖ Bien arriv√©(e)
                                </button>
                                <button class="btn btn-warning" onclick="sendQuickMessage('leaving')" style="padding: 0.5rem; font-size: 0.9rem;">
                                    üëã Je pars
                                </button>
                                <button class="btn btn-danger" onclick="sendQuickMessage('help')" style="padding: 0.5rem; font-size: 0.9rem;">
                                    üÜò Besoin d'aide
                                </button>
                            </div>
                        </div>

                        <!-- Custom Message -->
                        <div class="form-group">
                            <label class="form-label">Destinataire</label>
                            <select class="form-input" id="message-recipient">
                                <option value="family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Famille (Tous)</option>
                                <option value="emma">üëß Emma</option>
                                <option value="lucas">üë¶ Lucas</option>
                                <option value="sarah">üëß Sarah</option>
                                <option value="parents">üë´ Parents uniquement</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nouveau Message</label>
                            <textarea class="form-input" id="message-text" rows="3" placeholder="Tapez votre message personnalis√©..."></textarea>
                        </div>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i> Envoyer
                            </button>
                            <button class="btn btn-secondary" onclick="startVoiceMessage()">
                                <i class="fas fa-microphone"></i> Message Vocal
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="settings-page" class="page" style="display: none;">
                    <h1 class="page-title">Param√®tres</h1>
                    <div class="dashboard-grid">
                        <div class="card">
                            <h3 class="card-title">Profil utilisateur</h3>
                            <div class="form-group">
                                <label class="form-label">Nom</label>
                                <input type="text" class="form-input" value="Parent Terrano">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" value="parent@terrano.com">
                            </div>
                            <button class="btn btn-primary">Sauvegarder</button>
                        </div>
                        
                        <div class="card">
                            <h3 class="card-title">Notifications</h3>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" checked> Alertes SOS
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" checked> Notifications de zone
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox"> Rapports quotidiens
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alerts SOS Page -->
            <div id="alerts-page" class="page" style="display: none;">
                <h1 class="page-title"><i class="fas fa-exclamation-triangle"></i> Alertes SOS</h1>
                
                <!-- Emergency Actions -->
                <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- SOS Button -->
                    <div class="card" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; text-align: center;">
                        <div style="padding: 2rem; text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;" aria-hidden="true">
                                üö®
                            </div>
                            <h3 style="margin-bottom: 1rem; color: white;">URGENCE</h3>
                            <button id="sos-button" class="btn" onclick="triggerSOS()" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 1rem 2rem; font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer; transition: all 0.3s ease;" role="button" aria-label="D√©clencher une alerte SOS d'urgence" tabindex="0">
                                <i class="fas fa-phone" aria-hidden="true"></i> D√âCLENCHER SOS
                            </button>
                        </div>    <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.9;">
                                Appuyez en cas d'urgence imm√©diate
                            </p>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Actions Rapides</h3>
                        </div>
                        <div style="display: grid; gap: 1rem; padding: 1rem;">
                            <button class="btn btn-warning" onclick="sendLocationAlert()" style="padding: 1rem; text-align: left;">
                                <i class="fas fa-map-marker-alt"></i>
                                <div style="margin-left: 1rem; display: inline-block;">
                                    <strong>Partager Position</strong>
                                    <div style="font-size: 0.8rem; opacity: 0.8;">Envoyer ma localisation</div>
                                </div>
                            </button>
                            <button class="btn btn-info" onclick="requestPickup()" style="padding: 1rem; text-align: left;">
                                <i class="fas fa-car"></i>
                                <div style="margin-left: 1rem; display: inline-block;">
                                    <strong>Demander R√©cup√©ration</strong>
                                    <div style="font-size: 0.8rem; opacity: 0.8;">Besoin d'√™tre r√©cup√©r√©(e)</div>
                                </div>
                            </button>
                            <button class="btn btn-secondary" onclick="sendSafeMessage()" style="padding: 1rem; text-align: left;">
                                <i class="fas fa-check-circle"></i>
                                <div style="margin-left: 1rem; display: inline-block;">
                                    <strong>Signal "Tout va bien"</strong>
                                    <div style="font-size: 0.8rem; opacity: 0.8;">Rassurer la famille</div>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Emergency Map -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Localisation d'Urgence</h3>
                            <button class="btn btn-primary" onclick="refreshEmergencyMap()" style="padding: 0.5rem;">
                                <i class="fas fa-sync"></i>
                            </button>
                        </div>
                        <div style="position: relative; height: 300px; overflow: hidden; border-radius: 8px; background: #f8f9fa;">
                            <div id="emergency-map" style="width: 100%; height: 100%; border-radius: 8px; z-index: 1;"></div>
                            <div id="emergency-location-info" style="position: absolute; bottom: 10px; left: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 0.5rem; border-radius: 5px; font-size: 0.8rem; text-align: center; z-index: 1000;">
                                <i class="fas fa-map-marker-alt"></i> <span id="emergency-location-text">Chargement de la carte d'urgence...</span>
                            </div>
                            <div id="emergency-map-loading" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #f8f9fa; display: flex; align-items: center; justify-content: center; z-index: 999;">
                                <div style="text-align: center;">
                                    <div style="font-size: 2rem; color: #dc3545; margin-bottom: 1rem;">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                    <div style="color: #666;">Initialisation carte d'urgence...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Alerts -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Historique des Alertes</h3>
                        <span style="background: var(--success); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem;">3 alertes</span>
                    </div>
                    <div id="alerts-history">
                        <!-- Recent SOS Alert -->
                        <div class="alert-item" style="display: flex; align-items: center; padding: 1rem; border-left: 4px solid #dc3545; background: rgba(220, 53, 69, 0.1); margin-bottom: 1rem; border-radius: 0 8px 8px 0;">
                            <div style="width: 50px; height: 50px; background: #dc3545; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem;">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: between; align-items: center;">
                                    <strong style="color: #dc3545;">ALERTE SOS - Emma</strong>
                                    <span style="background: #dc3545; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; margin-left: auto;">URGENCE</span>
                                </div>
                                <div style="color: var(--gray-600); font-size: 0.9rem; margin: 0.5rem 0;">
                                    üìç √âcole Primaire Terrano - 8 Avenue de l'√âducation
                                </div>
                                <div style="font-size: 0.8rem; color: var(--gray-500);">
                                    <i class="fas fa-clock"></i> Aujourd'hui √† 14:32 - R√©solue en 3 min
                                </div>
                            </div>
                            <button class="btn btn-outline-primary" style="padding: 0.5rem;" onclick="viewAlertDetails('sos-001')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>

                        <!-- Location Share Alert -->
                        <div class="alert-item" style="display: flex; align-items: center; padding: 1rem; border-left: 4px solid #ffc107; background: rgba(255, 193, 7, 0.1); margin-bottom: 1rem; border-radius: 0 8px 8px 0;">
                            <div style="width: 50px; height: 50px; background: #ffc107; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem;">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: between; align-items: center;">
                                    <strong style="color: #ffc107;">Position Partag√©e - Lucas</strong>
                                    <span style="background: #ffc107; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; margin-left: auto;">LOCALISATION</span>
                                </div>
                                <div style="color: var(--gray-600); font-size: 0.9rem; margin: 0.5rem 0;">
                                    üìç Parc des Buttes-Chaumont - Pr√®s de l'aire de jeux
                                </div>
                                <div style="font-size: 0.8rem; color: var(--gray-500);">
                                    <i class="fas fa-clock"></i> Aujourd'hui √† 16:15 - Automatique
                                </div>
                            </div>
                            <button class="btn btn-outline-primary" style="padding: 0.5rem;" onclick="viewAlertDetails('loc-002')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>

                        <!-- Safe Message -->
                        <div class="alert-item" style="display: flex; align-items: center; padding: 1rem; border-left: 4px solid #28a745; background: rgba(40, 167, 69, 0.1); margin-bottom: 1rem; border-radius: 0 8px 8px 0;">
                            <div style="width: 50px; height: 50px; background: #28a745; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: between; align-items: center;">
                                    <strong style="color: #28a745;">Tout va bien - Sarah</strong>
                                    <span style="background: #28a745; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; margin-left: auto;">S√âCURIS√â</span>
                                </div>
                                <div style="color: var(--gray-600); font-size: 0.9rem; margin: 0.5rem 0;">
                                    üìç Chez Grand-m√®re - 42 Rue de la R√©publique
                                </div>
                                <div style="font-size: 0.8rem; color: var(--gray-500);">
                                    <i class="fas fa-clock"></i> Aujourd'hui √† 18:45 - Manuel
                                </div>
                            </div>
                            <button class="btn btn-outline-primary" style="padding: 0.5rem;" onclick="viewAlertDetails('safe-003')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>

                    </div>
                </div>

                <!-- Emergency Contacts -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Contacts d'Urgence</h3>
                        <button class="btn btn-primary" onclick="addEmergencyContact()">
                            <i class="fas fa-plus"></i> Ajouter
                        </button>
                    </div>
                    <div id="emergency-contacts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; padding: 1rem;">
                        <!-- Contacts will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Zones Page -->
            <div id="zones-page" class="page" style="display: none;">
                <h1 class="page-title"><i class="fas fa-shield-alt"></i> Zones S√ªres</h1>
                    
                    <!-- Add Zone Form -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <div class="card-header">
                            <h3 class="card-title">Cr√©er une Zone S√ªre</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Nom de la zone</label>
                                <input type="text" class="form-input" id="zone-name" placeholder="Ex: √âcole Primaire">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Type de zone</label>
                                <select class="form-input" id="zone-type">
                                    <option value="">S√©lectionner...</option>
                                    <option value="home">Domicile</option>
                                    <option value="school">√âcole</option>
                                    <option value="family">Famille</option>
                                    <option value="activity">Activit√©</option>
                                    <option value="medical">M√©dical</option>
                                    <option value="transport">Transport</option>
                                    <option value="other">Autre</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Adresse</label>
                                <input type="text" class="form-input" id="zone-address" placeholder="123 Rue de la Paix, Paris">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Rayon (m√®tres)</label>
                                <select class="form-input" id="zone-radius">
                                    <option value="50">50m - Tr√®s pr√©cis</option>
                                    <option value="100" selected>100m - Pr√©cis</option>
                                    <option value="200">200m - Moyen</option>
                                    <option value="500">500m - Large</option>
                                    <option value="1000">1km - Tr√®s large</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="addZone()">
                                <i class="fas fa-plus"></i> Cr√©er Zone S√ªre
                            </button>
                            <button class="btn btn-secondary" onclick="locateMe()" style="margin-left: 1rem;">
                                <i class="fas fa-location-arrow"></i> Ma Position
                            </button>
                        </div>
                    </div>

                    <!-- Active Zones -->
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Zones Actives</h3>
                                <span style="background: var(--success); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem;">4 zones</span>
                            </div>
                            <div id="active-zones">
                                <div class="zone-item" style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--success); border-radius: 8px; margin-bottom: 1rem; background: rgba(76, 175, 80, 0.1);">
                                    <div style="width: 60px; height: 60px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem;">
                                        <i class="fas fa-home"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <strong>Maison Familiale</strong>
                                        <div style="color: var(--gray-600); font-size: 0.9rem;">15 Rue des Lilas, Paris 12√®me</div>
                                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.8rem;">
                                            <span style="color: var(--success);"><i class="fas fa-circle"></i> Actif</span>
                                            <span style="color: var(--gray-600);">Rayon: 100m</span>
                                            <span style="color: var(--primary);">DOMICILE</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <button class="btn btn-warning" style="padding: 0.5rem;" onclick="editZone('home')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-danger" style="padding: 0.5rem;" onclick="deleteZone('home')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="zone-item" style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--primary); border-radius: 8px; margin-bottom: 1rem; background: rgba(255, 107, 53, 0.1);">
                                    <div style="width: 60px; height: 60px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem;">
                                        <i class="fas fa-school"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <strong>√âcole Primaire Terrano</strong>
                                        <div style="color: var(--gray-600); font-size: 0.9rem;">8 Avenue de l'√âducation, Paris 11√®me</div>
                                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.8rem;">
                                            <span style="color: var(--success);"><i class="fas fa-circle"></i> Actif</span>
                                            <span style="color: var(--gray-600);">Rayon: 200m</span>
                                            <span style="color: var(--primary);">√âCOLE</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <button class="btn btn-warning" style="padding: 0.5rem;" onclick="editZone('school')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-danger" style="padding: 0.5rem;" onclick="deleteZone('school')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="zone-item" style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--info); border-radius: 8px; margin-bottom: 1rem; background: rgba(23, 162, 184, 0.1);">
                                    <div style="width: 60px; height: 60px; background: var(--info); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem;">
                                        <i class="fas fa-heart"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <strong>Chez Grand-m√®re</strong>
                                        <div style="color: var(--gray-600); font-size: 0.9rem;">42 Rue du Bonheur, Boulogne</div>
                                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.8rem;">
                                            <span style="color: var(--success);"><i class="fas fa-circle"></i> Actif</span>
                                            <span style="color: var(--gray-600);">Rayon: 150m</span>
                                            <span style="color: var(--info);">FAMILLE</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <button class="btn btn-warning" style="padding: 0.5rem;" onclick="editZone('grandma')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-danger" style="padding: 0.5rem;" onclick="deleteZone('grandma')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="zone-item" style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--warning); border-radius: 8px; background: rgba(255, 193, 7, 0.1);">
                                    <div style="width: 60px; height: 60px; background: var(--warning); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem;">
                                        <i class="fas fa-futbol"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <strong>Club de Football</strong>
                                        <div style="color: var(--gray-600); font-size: 0.9rem;">Stade Municipal, Avenue du Sport</div>
                                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.8rem;">
                                            <span style="color: var(--success);"><i class="fas fa-circle"></i> Actif</span>
                                            <span style="color: var(--gray-600);">Rayon: 300m</span>
                                            <span style="color: var(--warning);">ACTIVIT√â</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <button class="btn btn-warning" style="padding: 0.5rem;" onclick="editZone('football')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-danger" style="padding: 0.5rem;" onclick="deleteZone('football')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="card-title">Carte Interactive</h3>
                            <div style="height: 300px; background: linear-gradient(135deg, #e8f5e8, #f0f8f0); border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                                <div style="position: absolute; top: 10px; right: 10px; background: white; padding: 0.5rem; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <i class="fas fa-map-marker-alt" style="color: var(--danger);"></i> Position actuelle
                                </div>
                                
                                <!-- Zone circles on map -->
                                <div style="position: absolute; top: 50px; left: 80px; width: 60px; height: 60px; border: 3px solid var(--success); border-radius: 50%; background: rgba(76, 175, 80, 0.2); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-home" style="color: var(--success);"></i>
                                </div>
                                
                                <div style="position: absolute; top: 120px; right: 60px; width: 80px; height: 80px; border: 3px solid var(--primary); border-radius: 50%; background: rgba(255, 107, 53, 0.2); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-school" style="color: var(--primary);"></i>
                                </div>
                                
                                <div style="position: absolute; bottom: 80px; left: 120px; width: 50px; height: 50px; border: 3px solid var(--info); border-radius: 50%; background: rgba(23, 162, 184, 0.2); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-heart" style="color: var(--info);"></i>
                                </div>
                                
                                <div style="position: absolute; bottom: 40px; right: 100px; width: 70px; height: 70px; border: 3px solid var(--warning); border-radius: 50%; background: rgba(255, 193, 7, 0.2); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-futbol" style="color: var(--warning);"></i>
                                </div>

                                <div style="text-align: center; color: var(--gray-600);">
                                    <i class="fas fa-map" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                                    <div>Carte interactive des zones s√ªres</div>
                                    <div style="font-size: 0.9rem; margin-top: 0.5rem;">Cliquez sur une zone pour plus de d√©tails</div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="card-title">Alertes et Notifications</h3>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; padding: 1rem; background: var(--success-light, #d4edda); border-left: 4px solid var(--success); border-radius: 4px; margin-bottom: 0.5rem;">
                                    <i class="fas fa-check-circle" style="color: var(--success); margin-right: 1rem;"></i>
                                    <div>
                                        <strong>Emma est arriv√©e √† l'√©cole</strong>
                                        <div style="font-size: 0.9rem; color: var(--gray-600);">Il y a 2 heures</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; padding: 1rem; background: var(--success-light, #d4edda); border-left: 4px solid var(--success); border-radius: 4px; margin-bottom: 0.5rem;">
                                    <i class="fas fa-check-circle" style="color: var(--success); margin-right: 1rem;"></i>
                                    <div>
                                        <strong>Emma a quitt√© l'√©cole</strong>
                                        <div style="font-size: 0.9rem; color: var(--gray-600);">Il y a 30 minutes</div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; padding: 1rem; background: var(--info-light, #d1ecf1); border-left: 4px solid var(--info); border-radius: 4px;">
                                    <i class="fas fa-info-circle" style="color: var(--info); margin-right: 1rem;"></i>
                                    <div>
                                        <strong>Emma est chez Grand-m√®re</strong>
                                        <div style="font-size: 0.9rem; color: var(--gray-600);">Il y a 15 minutes</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="card-title">Statistiques des Zones</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem;">
                                <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                    <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">4</div>
                                    <div style="font-size: 0.9rem; color: var(--gray-600);">Zones Actives</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                    <div style="font-size: 2rem; font-weight: bold; color: var(--success);">23</div>
                                    <div style="font-size: 0.9rem; color: var(--gray-600);">Entr√©es/Sorties</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                    <div style="font-size: 2rem; font-weight: bold; color: var(--info);">98%</div>
                                    <div style="font-size: 0.9rem; color: var(--gray-600);">Pr√©cision GPS</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                    <div style="font-size: 2rem; font-weight: bold; color: var(--warning);">0</div>
                                    <div style="font-size: 0.9rem; color: var(--gray-600);">Alertes Actives</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contacts Page -->
                <div id="contacts-page" class="page" style="display: none;">
                    <h1 class="page-title"><i class="fas fa-address-book"></i> Gestion des Contacts</h1>
                    
                    <!-- Add Contact Form -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <div class="card-header">
                            <h3 class="card-title">Ajouter un Contact</h3>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Nom complet</label>
                                <input type="text" class="form-input" id="contact-name" placeholder="Ex: Grand-m√®re Marie">
                            </div>
                            <div class="form-group">
                                <label class="form-label">T√©l√©phone</label>
                                <input type="tel" class="form-input" id="contact-phone" placeholder="06 12 34 56 78">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Relation</label>
                                <select class="form-input" id="contact-relation">
                                    <option value="">S√©lectionner...</option>
                                    <option value="parent">Parent</option>
                                    <option value="grand-parent">Grand-parent</option>
                                    <option value="famille">Famille</option>
                                    <option value="ami">Ami de famille</option>
                                    <option value="urgence">Contact d'urgence</option>
                                    <option value="ecole">√âcole/Cr√®che</option>
                                    <option value="medical">M√©dical</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Priorit√©</label>
                                <select class="form-input" id="contact-priority">
                                    <option value="normal">Normale</option>
                                    <option value="high">√âlev√©e</option>
                                    <option value="emergency">Urgence</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="addContact()">
                                <i class="fas fa-plus"></i> Ajouter Contact
                            </button>
                        </div>
                    </div>

                    <!-- Contacts List -->
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Contacts d'Urgence</h3>
                                <span style="background: var(--danger); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem;">Priorit√© Max</span>
                            </div>
                            <div id="emergency-contacts">
                                <div class="contact-item" style="display: flex; align-items: center; padding: 1rem; border: 1px solid var(--gray-200); border-radius: 8px; margin-bottom: 0.5rem;">
                                    <div style="width: 50px; height: 50px; background: var(--danger); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem; font-weight: bold;">
                                        <i class="fas fa-phone"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <strong>Services d'Urgence</strong>
                                        <div style="color: var(--gray-600); font-size: 0.9rem;">15 - SAMU</div>
                                        <div style="color: var(--danger); font-size: 0.8rem; font-weight: bold;">URGENCE</div>
                                    </div>
                                    <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="callContact('15')">
                                        <i class="fas fa-phone"></i>
                                    </button>
                                </div>
                                <div class="contact-item" style="display: flex; align-items: center; padding: 1rem; border: 1px solid var(--gray-200); border-radius: 8px; margin-bottom: 0.5rem;">
                                    <div style="width: 50px; height: 50px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem; font-weight: bold;">
                                        M
                                    </div>
                                    <div style="flex: 1;">
                                        <strong>Maman</strong>
                                        <div style="color: var(--gray-600); font-size: 0.9rem;">06 12 34 56 78</div>
                                        <div style="color: var(--primary); font-size: 0.8rem; font-weight: bold;">PARENT</div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-primary" style="padding: 0.5rem;" onclick="callContact('0612345678')">
                                            <i class="fas fa-phone"></i>
                                        </button>
                                        <button class="btn btn-secondary" style="padding: 0.5rem;" onclick="messageContact('Maman')">
                                            <i class="fas fa-comment"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Famille</h3>
                                <span style="background: var(--primary); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem;">3 contacts</span>
                            </div>
                            <div id="family-contacts">
                            <!-- Family contacts will be populated by JavaScript -->
                        </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Services & Professionnels</h3>
                                <span style="background: var(--warning); color: white; padding: 0.3rem 0.8rem; border-radius: 15px; font-size: 0.8rem;">2 contacts</span>
                            </div>
                            <div id="professional-contacts">
                                <!-- Professional contacts will be populated by JavaScript -->
                            </div>
                        </div>

                        <div class="card">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem;">
                                <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                    <div style="font-size: 2rem; font-weight: bold;">8</div>
                                    <div style="font-size: 0.9rem; color: var(--gray-600);">Contacts Total</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                    <div style="font-size: 2rem; font-weight: bold;">2</div>
                                    <div style="font-size: 0.9rem; color: var(--gray-600);">Urgence</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                    <div style="font-size: 2rem; font-weight: bold;">12</div>
                                    <div style="font-size: 0.9rem; color: var(--gray-600);">Appels ce mois</div>
                                </div>
                                <div style="text-align: center; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                    <div style="font-size: 2rem; font-weight: bold;">5</div>
                                    <div style="font-size: 0.9rem; color: var(--gray-600);">Messages envoy√©s</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Premium Page -->
                <div id="premium-page" class="page" style="display: none;">
                    <h1 class="page-title"><i class="fas fa-crown" style="color: gold;"></i> TerranoKidsFind Premium</h1>
                    
                    <!-- Current Plan -->
                    <div class="card" style="border: 2px solid var(--primary); margin-bottom: 2rem;">
                        <div class="card-header">
                            <h3 class="card-title">Plan Actuel : Gratuit</h3>
                            <span style="background: var(--gray-300); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">Version d'essai</span>
                        </div>
                        <p>Vous utilisez actuellement la version gratuite limit√©e de TerranoKidsFind.</p>
                        <div style="margin-top: 1rem;">
                            <strong>Limites actuelles :</strong>
                            <ul style="margin-left: 2rem; margin-top: 0.5rem;">
                                <li>1 enfant maximum</li>
                                <li>2 zones s√ªres</li>
                                <li>Historique limit√© √† 7 jours</li>
                                <li>Support par email uniquement</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Premium Features -->
                    <div class="dashboard-grid">
                        <div class="card" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white;">
                            <div class="card-header">
                                <h3 class="card-title" style="color: white;"><i class="fas fa-crown"></i> Premium</h3>
                                <div style="font-size: 2rem; font-weight: bold;">9,99‚Ç¨<span style="font-size: 1rem; opacity: 0.8;">/mois</span></div>
                            </div>
                            <ul style="list-style: none; padding: 0; margin: 1rem 0;">
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-check" style="color: #4CAF50; margin-right: 0.5rem;"></i> Enfants illimit√©s</li>
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-check" style="color: #4CAF50; margin-right: 0.5rem;"></i> Zones s√ªres illimit√©es</li>
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-check" style="color: #4CAF50; margin-right: 0.5rem;"></i> Historique complet (1 an)</li>
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-check" style="color: #4CAF50; margin-right: 0.5rem;"></i> √âcoute environnement</li>
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-check" style="color: #4CAF50; margin-right: 0.5rem;"></i> Contr√¥le applications</li>
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-check" style="color: #4CAF50; margin-right: 0.5rem;"></i> Support prioritaire 24/7</li>
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-check" style="color: #4CAF50; margin-right: 0.5rem;"></i> Rapports d√©taill√©s</li>
                                <li style="margin-bottom: 0.5rem;"><i class="fas fa-check" style="color: #4CAF50; margin-right: 0.5rem;"></i> Filtrage d'appels</li>
                            </ul>
                            <button class="btn" style="background: white; color: var(--primary); width: 100%; font-weight: bold;" onclick="upgradeToPremium()">
                                <i class="fas fa-crown"></i> Passer √† Premium
                            </button>
                        </div>

                        <div class="card">
                            <h3 class="card-title">Fonctionnalit√©s Premium</h3>
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="color: var(--primary); margin-bottom: 0.5rem;"><i class="fas fa-headphones"></i> √âcoute Environnement</h4>
                                <p style="font-size: 0.9rem; color: var(--gray-600);">√âcoutez discr√®tement l'environnement de vos enfants pour assurer leur s√©curit√©.</p>
                            </div>
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="color: var(--primary); margin-bottom: 0.5rem;"><i class="fas fa-mobile-alt"></i> Contr√¥le Applications</h4>
                                <p style="font-size: 0.9rem; color: var(--gray-600);">Bloquez ou limitez l'acc√®s √† certaines applications selon l'√¢ge.</p>
                            </div>
                            <div style="margin-bottom: 1.5rem;">
                                <h4 style="color: var(--primary); margin-bottom: 0.5rem;"><i class="fas fa-chart-line"></i> Analytics Avanc√©es</h4>
                                <p style="font-size: 0.9rem; color: var(--gray-600);">Rapports d√©taill√©s sur les habitudes et la s√©curit√© de vos enfants.</p>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="card-title">T√©moignages</h3>
                            <div style="margin-bottom: 1rem; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem;">M</div>
                                    <div>
                                        <strong>Marie L.</strong>
                                        <div style="color: gold; font-size: 0.9rem;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                                    </div>
                                </div>
                                <p style="font-style: italic; font-size: 0.9rem;">"Une tranquillit√© d'esprit inestimable. Je recommande vivement TerranoKidsFind Premium."</p>
                            </div>
                            <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="width: 40px; height: 40px; background: var(--secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem;">J</div>
                                    <div>
                                        <strong>Jean D.</strong>
                                        <div style="color: gold; font-size: 0.9rem;">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                                    </div>
                                </div>
                                <p style="font-style: italic; font-size: 0.9rem;">"Interface intuitive et fonctionnalit√©s compl√®tes. Parfait pour les familles modernes."</p>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="card-title">Questions Fr√©quentes</h3>
                            <div style="margin-bottom: 1rem;">
                                <strong style="color: var(--primary);">Puis-je annuler √† tout moment ?</strong>
                                <p style="font-size: 0.9rem; margin-top: 0.5rem;">Oui, vous pouvez annuler votre abonnement √† tout moment sans frais.</p>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <strong style="color: var(--primary);">Y a-t-il une p√©riode d'essai ?</strong>
                                <p style="font-size: 0.9rem; margin-top: 0.5rem;">Oui, profitez de 7 jours d'essai gratuit pour toutes les fonctionnalit√©s Premium.</p>
                            </div>
                            <div>
                                <strong style="color: var(--primary);">Mes donn√©es sont-elles s√©curis√©es ?</strong>
                                <p style="font-size: 0.9rem; margin-top: 0.5rem;">Absolument. Nous utilisons un chiffrement de niveau bancaire pour prot√©ger vos donn√©es.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Navigation
        function showPage(pageId) {
            // Hide all pages
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.style.display = 'none');
            
            // Show selected page
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.style.display = 'block';
                
                // Update navigation
                const navLinks = document.querySelectorAll('.nav-link');
                navLinks.forEach(link => link.classList.remove('active'));
                
                const activeLink = document.querySelector(`[onclick="showPage('${pageId}')"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
                
                // Update URL hash
                window.location.hash = pageId;
                
                // Initialize map when map page is shown
                if (pageId === 'map' && !window.mapInitialized) {
                    setTimeout(() => {
                        initializeMap();
                        window.mapInitialized = true;
                    }, 100);
                }
                
                // Initialize emergency map when alerts page is shown
                if (pageId === 'alerts') {
                    setTimeout(() => {
                        if (!window.emergencyMapInitialized) {
                            console.log('Initialisation de la carte d\'urgence pour la premi√®re fois');
                            initializeEmergencyMap();
                            window.emergencyMapInitialized = true;
                        } else if (emergencyMap) {
                            console.log('Redimensionnement de la carte d\'urgence existante');
                            emergencyMap.invalidateSize();
                            updateEmergencyMap();
                        }
                    }, 300);
                }
            }
        }

        // Theme Toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
        }

        // Load saved theme
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        // SOS Alert
        function triggerSOS() {
            if (confirm('D√©clencher une alerte SOS d\'urgence ?')) {
                alert('üö® Alerte SOS envoy√©e ! Les services d\'urgence ont √©t√© notifi√©s.');
            }
        }

        // Map functions
        function centerMap() {
            alert(' Centrage de la carte sur tous les enfants...\n\nLa vue est maintenant optimis√©e pour afficher tous vos enfants.');
        }

        function toggleZones() {
            alert(' Affichage des zones s√ªres activ√©/d√©sactiv√©\n\nLes zones de s√©curit√© sont maintenant visibles/masqu√©es sur la carte.');
        }

        function changeMapType(type) {
            const types = {
                'roadmap': 'Plan',
                'satellite': 'Satellite',
                'hybrid': 'Hybride',
                'terrain': 'Terrain'
            };
            alert(` Type de carte chang√©: ${types[type]}\n\nLa carte affiche maintenant la vue ${types[type].toLowerCase()}.`);
        }

        function refreshLocations() {
            alert(' Actualisation des positions...\n\nToutes les positions ont √©t√© mises √† jour avec les derni√®res donn√©es GPS.');
        }

        let currentZoom = 1;
        const maxZoom = 3;
        const minZoom = 0.5;

        function zoomIn() {
            if (currentZoom < maxZoom) {
                currentZoom += 0.2;
                applyZoom();
                alert(`üîç Zoom avant\n\nNiveau de zoom: ${Math.round(currentZoom * 100)}%`);
            } else {
                alert('üîç Zoom maximum atteint\n\nVous √™tes au niveau de zoom le plus √©lev√©.');
            }
        }

        function zoomOut() {
            if (currentZoom > minZoom) {
                currentZoom -= 0.2;
                applyZoom();
                alert(`üîç Zoom arri√®re\n\nNiveau de zoom: ${Math.round(currentZoom * 100)}%`);
            } else {
                alert('üîç Zoom minimum atteint\n\nVous √™tes au niveau de zoom le plus bas.');
            }
        }

        function applyZoom() {
            const mapContainer = document.querySelector('#map-page .card div[style*="height: 500px"]');
            if (mapContainer) {
                // Apply zoom transformation
                mapContainer.style.transform = `scale(${currentZoom})`;
                mapContainer.style.transformOrigin = 'center center';
                
                // Adjust container to prevent overflow
                const parentCard = mapContainer.parentElement;
                if (parentCard) {
                    parentCard.style.overflow = 'hidden';
                }
                
                // Update zoom level display
                updateZoomDisplay();
            }
        }

        function updateZoomDisplay() {
            // Add zoom level indicator if it doesn't exist
            let zoomIndicator = document.getElementById('zoom-indicator');
            if (!zoomIndicator) {
                zoomIndicator = document.createElement('div');
                zoomIndicator.id = 'zoom-indicator';
                zoomIndicator.style.cssText = `
                    position: absolute;
                    top: 170px;
                    right: 10px;
                    background: rgba(0,0,0,0.7);
                    color: white;
                    padding: 0.5rem;
                    border-radius: 4px;
                    font-size: 0.8rem;
                    z-index: 15;
                `;
                
                const mapContainer = document.getElementById('interactive-map');
                if (mapContainer) {
                    mapContainer.appendChild(zoomIndicator);
                }
            }
            
            if (zoomIndicator) {
                zoomIndicator.textContent = `Zoom: ${Math.round(currentZoom * 100)}%`;
            }
        }

        function resetZoom() {
            currentZoom = 1;
            applyZoom();
            alert('üîÑ Zoom r√©initialis√©\n\nLa carte est revenue au niveau de zoom par d√©faut (100%).');
        }

        // Leaflet Map Variables
        let map;
        let userMarker;
        let userAccuracyCircle;
        let userPulseEffect;
        let childMarkers = {};
        let childTrackingIntervals = {};
        let safeZoneCircles = [];
        let currentMapLayer = 'streets';
        let showingSafeZones = true;
        let showingTraffic = false;
        let trafficLayer = null;
        let mapWatchId = null;
        
        // Real-time child tracking data with actual GPS coordinates
        let childrenData = {
            emma: {
                lat: 48.8606,
                lng: 2.3376,
                speed: 0.0001, // Movement speed
                direction: Math.random() * 360,
                lastUpdate: new Date(),
                accuracy: 2,
                status: '√Ä l\'√©cole'
            },
            lucas: {
                lat: 48.8556,
                lng: 2.3522,
                speed: 0.00008,
                direction: Math.random() * 360,
                lastUpdate: new Date(),
                accuracy: 2,
                status: '√Ä la maison'
            },
            sarah: {
                lat: 48.8496,
                lng: 2.3468,
                speed: 0.00012,
                direction: Math.random() * 360,
                lastUpdate: new Date(),
                accuracy: 2,
                status: 'Chez grand-m√®re'
            }
        };

        // Sync emergency map with main map data
        function syncEmergencyMapWithMainMap() {
            if (childMarkers && Object.keys(childMarkers).length > 0) {
                Object.keys(childMarkers).forEach(childId => {
                    if (childMarkers[childId]) {
                        const position = childMarkers[childId].getLatLng();
                        if (childrenData[childId]) {
                            childrenData[childId].lat = position.lat;
                            childrenData[childId].lng = position.lng;
                            childrenData[childId].lastUpdate = new Date();
                        }
                    }
                });
            }
        }

        // Initialize Real Satellite Map
        function initializeMap() {
            // Check if map container exists and is visible
            const mapContainer = document.getElementById('interactive-map');
            if (!mapContainer) {
                console.error('Map container not found');
                return;
            }

            // Destroy existing map if it exists
            if (map) {
                map.remove();
                map = null;
            }

            try {
                // Create map centered on Paris (will be updated with user location)
                map = L.map('interactive-map', {
                    center: [48.8566, 2.3522],
                    zoom: 13,
                    zoomControl: false // We'll use custom controls
                });

                // Add OpenStreetMap layer (default)
                const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                });

                // Add satellite layer (Esri World Imagery)
                const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '¬© Esri, Maxar, Earthstar Geographics',
                    maxZoom: 19
                });

                // Add hybrid layer (satellite + labels)
                const hybridLayer = L.layerGroup([
                    satelliteLayer,
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
                        attribution: '¬© Esri',
                        maxZoom: 19
                    })
                ]);

                // Start with street map
                streetLayer.addTo(map);

                // Store layers for switching
                window.mapLayers = {
                    streets: streetLayer,
                    satellite: satelliteLayer,
                    hybrid: hybridLayer
                };

                // Initialize traffic layer (Google Maps traffic overlay)
                trafficLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=h@159000000,traffic&x={x}&y={y}&z={z}', {
                    attribution: '¬© Google Maps',
                    maxZoom: 20,
                    opacity: 0.7
                });

                // Add child markers with real coordinates (example locations)
                addChildMarkers();
                
                // Add safe zones
                addSafeZones();

                // Update location info
                updateLocationDisplay();

                // Start high-precision location tracking
                startHighPrecisionTracking();

                // Force map to resize after initialization
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                    }
                }, 200);

            } catch (error) {
                console.error('Erreur lors de l\'initialisation de la carte:', error);
                document.getElementById('location-text').textContent = 'Erreur de chargement de la carte';
            }
        }

        function addChildMarkers() {
            // Create custom icon with real-time pulse effect
            const createChildIcon = (color, letter, isMoving = false) => {
                const pulseClass = isMoving ? 'child-location-pulse' : '';
                return L.divIcon({
                    className: 'child-marker-container',
                    html: `<div style="position: relative; width: 40px; height: 40px;">
                             ${isMoving ? `<div class="${pulseClass}" style="background: ${color}; border-color: ${color};"></div>` : ''}
                             <img src="https://res.cloudinary.com/dxy0fiahv/image/upload/v1756139122/logo_tfinds_laf9do.png" 
                                  style="width: 40px; height: 40px; border-radius: 50%; border: 3px solid ${color}; box-shadow: 0 2px 8px rgba(0,0,0,0.3); position: relative; z-index: 10;">
                             <div style="position: absolute; bottom: -5px; right: -5px; background: ${color}; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border: 2px solid white; z-index: 11;">${letter}</div>
                           </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
            };

            // Initialize child markers with real-time tracking
            Object.keys(childrenData).forEach(childId => {
                const child = childrenData[childId];
                const colors = {
                    emma: '#FF6B35',
                    lucas: '#28a745', 
                    sarah: '#17a2b8'
                };
                const letters = {
                    emma: 'E',
                    lucas: 'L',
                    sarah: 'S'
                };

                const marker = L.marker([child.lat, child.lng], {
                    icon: createChildIcon(colors[childId], letters[childId], true)
                }).addTo(map);

                const popupContent = `
                    <b>${childId.charAt(0).toUpperCase() + childId.slice(1)}</b><br>
                    ${child.status}<br>
                    <small>üìç Pr√©cision: ¬±${child.accuracy}m</small><br>
                    <small>‚è∞ Derni√®re mise √† jour: <span id="time-${childId}">maintenant</span></small>
                `;
                marker.bindPopup(popupContent);
                childMarkers[childId] = marker;
            });

            // Start real-time tracking for all children
            startChildrenTracking();
        }

        function startChildrenTracking() {
            Object.keys(childrenData).forEach(childId => {
                // Update every 3 seconds for real-time effect
                childTrackingIntervals[childId] = setInterval(() => {
                    updateChildPosition(childId);
                }, 3000);
            });
        }

        function updateChildPosition(childId) {
            const child = childrenData[childId];
            
            // Simulate realistic movement with 2m precision
            const moveDistance = child.speed;
            const directionChange = (Math.random() - 0.5) * 30; // ¬±15 degrees
            child.direction += directionChange;
            
            // Calculate new position
            const latChange = moveDistance * Math.cos(child.direction * Math.PI / 180);
            const lngChange = moveDistance * Math.sin(child.direction * Math.PI / 180);
            
            child.lat += latChange;
            child.lng += lngChange;
            child.lastUpdate = new Date();
            
            // Add small random precision variation (¬±2m)
            const precisionVariation = (Math.random() - 0.5) * 0.000036; // ~2m in degrees
            const displayLat = child.lat + precisionVariation;
            const displayLng = child.lng + precisionVariation;
            
            // Update marker position on main map
            if (childMarkers[childId]) {
                childMarkers[childId].setLatLng([displayLat, displayLng]);
                
                // Update popup with current time
                const popupContent = `
                    <b>${childId.charAt(0).toUpperCase() + childId.slice(1)}</b><br>
                    ${child.status}<br>
                    <small>üìç Pr√©cision: ¬±${child.accuracy}m</small><br>
                    <small>‚è∞ Derni√®re mise √† jour: ${child.lastUpdate.toLocaleTimeString()}</small><br>
                    <small>üö∂ En mouvement</small>
                `;
                childMarkers[childId].setPopupContent(popupContent);
            }
            
            // Update emergency map marker position
            if (emergencyMarkers[childId]) {
                emergencyMarkers[childId].setLatLng([displayLat, displayLng]);
            }
            
            // Update dashboard if visible
            updateChildDashboard(childId);
        }

        function updateChildDashboard(childId) {
            const child = childrenData[childId];
            const timeElement = document.getElementById(`time-${childId}`);
            if (timeElement) {
                const timeDiff = Math.floor((new Date() - child.lastUpdate) / 1000);
                timeElement.textContent = timeDiff < 10 ? 'maintenant' : `il y a ${timeDiff}s`;
            }
        }

        function addSafeZones() {
            // Safe zone around home
            const homeZone = L.circle([48.8556, 2.3522], {
                color: '#28a745',
                fillColor: '#28a745',
                fillOpacity: 0.1,
                radius: 100,
                weight: 2,
                dashArray: '5, 5'
            }).addTo(map);
            homeZone.bindPopup('<b>Zone S√ªre: Maison</b><br>Rayon: 100m');
            safeZoneCircles.push(homeZone);

            // Safe zone around school
            const schoolZone = L.circle([48.8606, 2.3376], {
                color: '#FF6B35',
                fillColor: '#FF6B35',
                fillOpacity: 0.1,
                radius: 150,
                weight: 2,
                dashArray: '5, 5'
            }).addTo(map);
            schoolZone.bindPopup('<b>Zone S√ªre: √âcole</b><br>Rayon: 150m');
            safeZoneCircles.push(schoolZone);

            // Safe zone around grandmother's
            const grandmaZone = L.circle([48.8496, 2.3468], {
                color: '#17a2b8',
                fillColor: '#17a2b8',
                fillOpacity: 0.1,
                radius: 80,
                weight: 2,
                dashArray: '5, 5'
            }).addTo(map);
            grandmaZone.bindPopup('<b>Zone S√ªre: Grand-m√®re</b><br>Rayon: 80m');
            safeZoneCircles.push(grandmaZone);
        }

        function changeMapLayer(layerType) {
            if (!map || !window.mapLayers) {
                console.error('Carte non initialis√©e');
                return;
            }

            // Remove current layer
            map.eachLayer(function(layer) {
                if (layer instanceof L.TileLayer || layer instanceof L.LayerGroup) {
                    if (layer !== window.mapLayers.streets && layer !== window.mapLayers.satellite && layer !== window.mapLayers.hybrid) {
                        return; // Keep markers and other elements
                    }
                    map.removeLayer(layer);
                }
            });

            // Add new layer
            if (window.mapLayers[layerType]) {
                window.mapLayers[layerType].addTo(map);
                currentMapLayer = layerType;
                
                const layerNames = {
                    'streets': 'Plan des rues',
                    'satellite': 'Vue satellite',
                    'hybrid': 'Vue hybride'
                };
                
                const locationText = document.getElementById('location-text');
                if (locationText) {
                    locationText.textContent = `Carte: ${layerNames[layerType]}`;
                }
            }
        }

        function centerOnUser() {
            if (!map) {
                console.error('Carte non initialis√©e');
                return;
            }

            if (navigator.geolocation && map) {
                // Get current position with high precision and center map
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        map.setView([lat, lng], 18);
                        
                        // Force update user location on map
                        updateUserLocationOnMap(position);
                    },
                    function(error) {
                        handleLocationError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }

        function toggleTraffic() {
            if (!map || !trafficLayer) {
                console.error('Carte ou couche trafic non initialis√©e');
                return;
            }

            showingTraffic = !showingTraffic;
            const trafficBtn = document.getElementById('traffic-btn');
            
            if (showingTraffic) {
                trafficLayer.addTo(map);
                if (trafficBtn) {
                    trafficBtn.classList.remove('btn-warning');
                    trafficBtn.classList.add('btn-danger');
                    trafficBtn.style.background = '#dc3545';
                }
                
                const locationText = document.getElementById('location-text');
                if (locationText) {
                    locationText.innerHTML = `üöó Trafic activ√©<br><small>Conditions de circulation en temps r√©el</small>`;
                }
            } else {
                map.removeLayer(trafficLayer);
                if (trafficBtn) {
                    trafficBtn.classList.remove('btn-danger');
                    trafficBtn.classList.add('btn-warning');
                    trafficBtn.style.background = '#ffc107';
                }
                
                const locationText = document.getElementById('location-text');
                if (locationText) {
                    locationText.innerHTML = `üöó Trafic d√©sactiv√©`;
                }
            }
        }

        function toggleSafeZones() {
            if (!map) {
                console.error('Carte non initialis√©e');
                return;
            }

            showingSafeZones = !showingSafeZones;
            
            safeZoneCircles.forEach(circle => {
                if (showingSafeZones) {
                    circle.addTo(map);
                } else {
                    map.removeLayer(circle);
                }
            });
            
            const status = showingSafeZones ? 'affich√©es' : 'masqu√©es';
            const locationText = document.getElementById('location-text');
            if (locationText) {
                locationText.textContent = `Zones s√ªres ${status}`;
            }
        }

        function centerOnChildren() {
            if (!map || Object.keys(childMarkers).length === 0) {
                console.error('Carte ou marqueurs enfants non initialis√©s');
                return;
            }

            // Get all child positions
            const positions = Object.keys(childrenData).map(childId => {
                const child = childrenData[childId];
                return [child.lat, child.lng];
            });

            // Create bounds that include all children
            const group = new L.featureGroup(Object.values(childMarkers));
            map.fitBounds(group.getBounds().pad(0.1));

            const locationText = document.getElementById('location-text');
            if (locationText) {
                locationText.innerHTML = `üë• Vue centr√©e sur tous les enfants<br><small>Suivi temps r√©el actif</small>`;
            }
        }

        // SOS and Emergency Functions
        let sosActive = false;
        let sosTimeout = null;
        let emergencyMap = null;
        let emergencyMarkers = {};

        function triggerSOS() {
            if (sosActive) {
                cancelSOS();
                return;
            }

            sosActive = true;
            const sosBtn = document.getElementById('sos-button');
            
            // Visual feedback
            sosBtn.innerHTML = '<i class="fas fa-times"></i> ANNULER SOS';
            sosBtn.style.background = '#28a745';
            sosBtn.style.color = 'white';
            
            // Start countdown
            let countdown = 10;
            const countdownInterval = setInterval(() => {
                sosBtn.innerHTML = `<i class="fas fa-times"></i> ANNULER (${countdown}s)`;
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(countdownInterval);
                    executeSOS();
                }
            }, 1000);
            
            // Store interval for cancellation
            sosTimeout = countdownInterval;
            
            // Show notification
            showNotification('üö® SOS sera d√©clench√© dans 10 secondes. Appuyez pour annuler.', 'warning');
        }

        function cancelSOS() {
            sosActive = false;
            if (sosTimeout) {
                clearInterval(sosTimeout);
                sosTimeout = null;
            }
            
            const sosBtn = document.getElementById('sos-button');
            sosBtn.innerHTML = '<i class="fas fa-phone"></i> D√âCLENCHER SOS';
            sosBtn.style.background = 'white';
            sosBtn.style.color = '#dc3545';
            
            showNotification('‚úÖ SOS annul√©', 'success');
        }

        function executeSOS() {
            sosActive = false;
            const sosBtn = document.getElementById('sos-button');
            sosBtn.innerHTML = '<i class="fas fa-check"></i> SOS ENVOY√â';
            sosBtn.style.background = '#dc3545';
            sosBtn.style.color = 'white';
            
            // Get current location for SOS
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        sendSOSAlert(latitude, longitude);
                    },
                    () => {
                        sendSOSAlert(null, null);
                    },
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            } else {
                sendSOSAlert(null, null);
            }
            
            // Reset button after 5 seconds
            setTimeout(() => {
                sosBtn.innerHTML = '<i class="fas fa-phone"></i> D√âCLENCHER SOS';
                sosBtn.style.background = 'white';
                sosBtn.style.color = '#dc3545';
            }, 5000);
        }

        function sendSOSAlert(lat, lng) {
            const locationText = lat && lng ? 
                `üìç Position: ${lat.toFixed(6)}, ${lng.toFixed(6)}` : 
                'üìç Position indisponible';
                
            // Simulate sending SOS to emergency contacts
            showNotification(`üö® ALERTE SOS ENVOY√âE!\n${locationText}\nüìû Contacts d'urgence notifi√©s`, 'error');
            
            // Add to alerts history
            addAlertToHistory('SOS', 'URGENCE', locationText, '#dc3545');
            
            // Trigger emergency actions
            callEmergency('17'); // Auto-call police
        }

        function sendLocationAlert() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const locationText = `üìç Position partag√©e: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                        
                        showNotification('üìç Position partag√©e avec la famille', 'info');
                        addAlertToHistory('Position Partag√©e', 'LOCALISATION', locationText, '#ffc107');
                    },
                    () => {
                        showNotification('‚ùå Impossible d\'obtenir la position', 'error');
                    },
                    { enableHighAccuracy: true, timeout: 5000 }
                );
            }
        }

        function requestPickup() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const locationText = `üìç R√©cup√©ration demand√©e: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                        
                        showNotification('üöó Demande de r√©cup√©ration envoy√©e', 'warning');
                        addAlertToHistory('Demande R√©cup√©ration', 'TRANSPORT', locationText, '#17a2b8');
                    },
                    () => {
                        showNotification('‚ùå Impossible d\'obtenir la position', 'error');
                    }
                );
            }
        }

        function sendSafeMessage() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const locationText = `üìç Signal s√©curis√©: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                        
                        showNotification('‚úÖ Signal "Tout va bien" envoy√©', 'success');
                        addAlertToHistory('Tout va bien', 'S√âCURIS√â', locationText, '#28a745');
                    },
                    () => {
                        const locationText = 'üìç Position indisponible';
                        showNotification('‚úÖ Signal "Tout va bien" envoy√©', 'success');
                        addAlertToHistory('Tout va bien', 'S√âCURIS√â', locationText, '#28a745');
                    }
                );
            }
        }

        function callEmergency(number) {
            showNotification(`üìû Appel vers ${number}`, 'info');
            // In a real app, this would initiate a phone call
            window.location.href = `tel:${number}`;
        }

        function messageContact(contactId, contactName) {
            showNotification(`üí¨ Message vers ${contactName}`, 'info');
            // In a real app, this would open SMS app
            const contact = emergencyContacts.find(c => c.id === contactId);
            if (contact) {
                window.location.href = `sms:${contact.phone}?body=Bonjour, j'ai besoin d'aide urgente. Localisation: [Position GPS]`;
            }
        }

        function addAlertToHistory(title, type, location, color) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            // This would normally save to database
            console.log(`Nouvelle alerte: ${title} - ${type} - ${location} √† ${timeStr}`);
        }

        function viewAlertDetails(alertId) {
            showNotification(`üìã D√©tails de l'alerte ${alertId}`, 'info');
        }

        // Emergency contacts storage
        let emergencyContacts = [
            { id: 'police', name: 'Police Secours', phone: '17', type: 'service', color: 'var(--primary)', icon: 'fas fa-phone' },
            { id: 'samu', name: 'SAMU', phone: '15', type: 'service', color: '#dc3545', icon: 'fas fa-ambulance' },
            { id: 'pompiers', name: 'Pompiers', phone: '18', type: 'service', color: '#ffc107', icon: 'fas fa-fire' },
            { id: 'papa', name: 'Papa', phone: '+33 6 12 34 56 78', type: 'personal', color: 'var(--info)', icon: 'fas fa-user' }
        ];

        function addEmergencyContact() {
            // Create modal for adding contact
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 10000; 
                display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <h3 style="margin-bottom: 1.5rem; color: #333; text-align: center;">
                        <i class="fas fa-user-plus"></i> Ajouter Contact d'Urgence
                    </h3>
                    <form id="emergency-contact-form">
                        <div style="margin-bottom: 1rem;">
                            <label for="contact-name" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Nom du contact</label>
                            <input type="text" id="contact-name" name="contact-name" placeholder="Ex: Maman" style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;" required pattern="[A-Za-z\s]{2,50}" aria-describedby="contact-name-help">
                            <div id="contact-name-help" class="sr-only">Entrez le nom du contact (2-50 caract√®res, lettres uniquement)</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label for="contact-phone" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Num√©ro de t√©l√©phone</label>
                            <input type="tel" id="contact-phone" name="contact-phone" placeholder="Ex: +33 6 12 34 56 78" style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;" required pattern="^(\+33|0)[1-9]([0-9]{8})$" aria-describedby="contact-phone-help">
                            <div id="contact-phone-help" class="sr-only">Entrez un num√©ro de t√©l√©phone fran√ßais valide (ex: +33 6 12 34 56 78 ou 06 12 34 56 78)</div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label for="contact-relation" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Relation</label>
                            <select id="contact-relation" name="contact-relation" style="width: 100%; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;" required aria-describedby="contact-relation-help">
                                <option value="parent">Parent</option>
                                <option value="family">Famille</option>
                                <option value="friend">Ami(e)</option>
                                <option value="neighbor">Voisin(e)</option>
                                <option value="doctor">M√©decin</option>
                                <option value="school">√âcole</option>
                                <option value="other">Autre</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button type="button" id="cancel-contact-btn" style="flex: 1; padding: 0.75rem; background: #6c757d; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer;" aria-label="Annuler l'ajout de contact">
                                <i class="fas fa-times" aria-hidden="true"></i> Annuler
                            </button>
                            <button type="submit" style="flex: 1; padding: 0.75rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer;" aria-label="Ajouter le contact d'urgence">
                                <i class="fas fa-plus" aria-hidden="true"></i> Ajouter
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle cancel button click
            document.getElementById('cancel-contact-btn').addEventListener('click', function() {
                closeContactModal();
            });
            
            // Handle form submission
            document.getElementById('emergency-contact-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                let messageHistory = [
                    { id: 1, type: 'sent', content: 'Salut, je suis bien arriv√© √† l\'√©cole !', timestamp: '09:15', contact: 'Papa' },
                    { id: 2, type: 'received', content: 'Parfait ! Passe une bonne journ√©e üòä', timestamp: '09:16', contact: 'Papa' },
                    { id: 3, type: 'sent', content: 'Je pars de l\'√©cole maintenant', timestamp: '16:30', contact: 'Maman' }
                ];

                function startVoiceMessage() {
            // V√©rifier le support de la reconnaissance vocale
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                // Fallback: simulation de reconnaissance vocale
                showNotification('üé§ Simulation de reconnaissance vocale...', 'info');
                
                setTimeout(() => {
                    const simulatedMessages = [
                        "Je suis bien arriv√© √† l'√©cole",
                        "Tout va bien, je rentre bient√¥t",
                        "J'ai besoin d'aide",
                        "Je suis chez grand-m√®re",
                        "Pouvez-vous venir me chercher ?"
                    ];
                    
                    const randomMessage = simulatedMessages[Math.floor(Math.random() * simulatedMessages.length)];
                    const messageInput = document.getElementById('message-input');
                    if (messageInput) {
                        messageInput.value = randomMessage;
                    }
                    showNotification('‚úÖ Message vocal simul√©: "' + randomMessage + '"', 'success');
                }, 2000);
                return;
            }

            const recognition = new SpeechRecognition();
            
            // Configuration plus permissive pour file://
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'fr-FR';
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                showNotification('üé§ Enregistrement vocal d√©marr√©...', 'info');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                const messageInput = document.getElementById('message-input');
                if (messageInput) {
                    messageInput.value = transcript;
                }
                showNotification('‚úÖ Message vocal transcrit: "' + transcript + '"', 'success');
            };

            recognition.onerror = function(event) {
                console.warn('Erreur reconnaissance vocale:', event.error);
                // Fallback en cas d'erreur
                const fallbackMessages = [
                    "Message vocal non disponible",
                    "Reconnaissance vocale limit√©e",
                    "Veuillez taper votre message"
                ];
                const fallbackMessage = fallbackMessages[Math.floor(Math.random() * fallbackMessages.length)];
                const messageInput = document.getElementById('message-input');
                if (messageInput) {
                    messageInput.placeholder = fallbackMessage;
                }
                showNotification('‚ö†Ô∏è Reconnaissance vocale limit√©e - Veuillez taper votre message', 'warning');
            };

            recognition.onend = function() {
                showNotification('üé§ Enregistrement termin√©', 'info');
            };

            try {
                recognition.start();
            } catch (error) {
                console.warn('Impossible de d√©marrer la reconnaissance vocale:', error);
                showNotification('‚ö†Ô∏è Reconnaissance vocale non disponible - Mode simulation activ√©', 'warning');
                // D√©clencher le fallback
                recognition.onerror({ error: 'not-allowed' });
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const recipientSelect = document.getElementById('message-recipient');
            
            if (messageInput && messageInput.value.trim()) {
                const newMessage = {
                    id: Date.now(),
                    type: 'sent',
                    content: messageInput.value.trim(),
                    timestamp: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                    contact: recipientSelect ? recipientSelect.value : 'Papa'
                };
                
                messageHistory.push(newMessage);
                refreshMessageHistory();
                messageInput.value = '';
                showNotification('‚úÖ Message envoy√© !', 'success');
                
                // Simulate response
                setTimeout(() => {
                    const response = {
                        id: Date.now() + 1,
                        type: 'received',
                        content: 'Message re√ßu ! Merci de nous tenir inform√©s üëç',
                        timestamp: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
                        contact: 'Papa'
                    };
                    messageHistory.push(response);
                    refreshMessageHistory();
                    showNotification('üì± Nouveau message re√ßu', 'info');
                }, 2000);
            } else {
                showNotification('‚ö†Ô∏è Veuillez saisir un message', 'warning');
            }
        }

                function refreshMessageHistory() {
                    const container = document.querySelector('#message-history');
                    if (!container) return;

                    container.innerHTML = '';

                    messageHistory.slice(-10).forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.style.cssText = `
                            display: flex; margin-bottom: 1rem;
                            ${msg.type === 'sent' ? 'justify-content: flex-end;' : 'justify-content: flex-start;'}
                        `;

                        const bubbleColor = msg.type === 'sent' ? 'var(--primary)' : 'var(--gray-200)';
                        const textColor = msg.type === 'sent' ? 'white' : 'var(--gray-800)';

                        messageDiv.innerHTML = `
                            <div style="max-width: 70%; padding: 0.75rem 1rem; border-radius: 18px; background: ${bubbleColor}; color: ${textColor};">
                                <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">${msg.content}</div>
                                <div style="font-size: 0.7rem; opacity: 0.7; text-align: right;">
                                    ${msg.contact} ‚Ä¢ ${msg.timestamp}
                                </div>
                            </div>
                        `;

                        container.appendChild(messageDiv);
                    });

                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                }

                function sendQuickMessage(messageType) {
                    const quickMessages = {
                        'safe': 'Je vais bien, tout se passe normalement üëç',
                        'arrived': 'Je suis bien arriv√©(e) √† destination ‚úÖ',
                        'leaving': 'Je pars maintenant, √† bient√¥t ! üëã',
                        'help': 'J\'ai besoin d\'aide, pouvez-vous m\'appeler ? üÜò'
                    };

                    const message = quickMessages[messageType];
                    if (message) {
                        document.getElementById('message-text').value = message;
                        sendMessage();
                    }
                }

                const name = document.getElementById('contact-name').value.trim();
                const phone = document.getElementById('contact-phone').value.trim();
                const relation = document.getElementById('contact-relation').value;
                
                if (name && phone) {
                    const newContact = {
                        id: 'contact_' + Date.now(),
                        name: name,
                        phone: phone,
                        type: 'personal',
                        relation: relation,
                        color: getRelationColor(relation),
                        icon: getRelationIcon(relation)
                    };
                    
                    emergencyContacts.push(newContact);
                    refreshEmergencyContacts();
                    showNotification(`‚úÖ Contact ajout√©: ${name}`, 'success');
                    closeContactModal();
                } else {
                    showNotification('‚ùå Veuillez remplir tous les champs', 'error');
                }
            });
            
            // Focus on first input
            setTimeout(() => {
                document.getElementById('contact-name').focus();
            }, 100);
        }

        function closeContactModal() {
            const modals = document.querySelectorAll('div[style*="position: fixed"]');
            modals.forEach(modal => {
                if (modal.parentNode) {
                    modal.parentNode.removeChild(modal);
                }
            });
        }

        function getRelationColor(relation) {
            const colors = {
                parent: '#28a745',
                family: '#17a2b8',
                friend: '#ffc107',
                neighbor: '#6f42c1',
                doctor: '#dc3545',
                school: '#fd7e14',
                other: '#6c757d'
            };
            return colors[relation] || '#6c757d';
        }

        function getRelationIcon(relation) {
            const icons = {
                parent: 'fas fa-heart',
                family: 'fas fa-users',
                friend: 'fas fa-user-friends',
                neighbor: 'fas fa-home',
                doctor: 'fas fa-user-md',
                school: 'fas fa-school',
                other: 'fas fa-user'
            };
            return icons[relation] || 'fas fa-user';
        }

        function refreshEmergencyContacts() {
            const container = document.querySelector('#emergency-contacts-grid');
            if (!container) return;
            
            container.innerHTML = '';
            
            emergencyContacts.forEach(contact => {
                const contactDiv = document.createElement('div');
                contactDiv.style.cssText = `
                    display: flex; align-items: center; padding: 1rem; 
                    border: 2px solid ${contact.color}; border-radius: 8px; 
                    background: ${contact.color}15; position: relative;
                `;
                
                contactDiv.innerHTML = `
                    <div style="width: 50px; height: 50px; background: ${contact.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; margin-right: 1rem;">
                        <i class="${contact.icon}"></i>
                    </div>
                    <div style="flex: 1;">
                        <strong>${contact.name}</strong>
                        <div style="color: var(--gray-600); font-size: 0.9rem;">${contact.phone}</div>
                        ${contact.relation ? `<div style="font-size: 0.8rem; color: ${contact.color}; text-transform: uppercase; font-weight: bold;">${contact.relation}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" onclick="callEmergency('${contact.phone}')" style="padding: 0.5rem;" title="Appeler ${contact.name}">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="btn btn-info" onclick="messageContact('${contact.id}', '${contact.name}')" style="padding: 0.5rem;" title="Envoyer un SMS √† ${contact.name}">
                            <i class="fas fa-comment"></i>
                        </button>
                        ${contact.type === 'personal' ? `<button class="btn btn-danger" onclick="removeEmergencyContact('${contact.id}')" style="padding: 0.5rem;" title="Supprimer ${contact.name}"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                `;
                
                container.appendChild(contactDiv);
            });
        }

        function removeEmergencyContact(contactId) {
            if (confirm('Supprimer ce contact d\'urgence ?')) {
                emergencyContacts = emergencyContacts.filter(contact => contact.id !== contactId);
                refreshEmergencyContacts();
                showNotification('üóëÔ∏è Contact supprim√©', 'info');
            }
        }

        // Emergency Map Functions
        function initializeEmergencyMap() {
            const mapContainer = document.getElementById('emergency-map');
            const loadingDiv = document.getElementById('emergency-map-loading');
            
            if (!mapContainer) {
                console.error('Container emergency-map non trouv√©');
                return;
            }

            if (emergencyMap) {
                console.log('Carte d\'urgence d√©j√† initialis√©e');
                return;
            }

            try {
                console.log('Initialisation de la carte d\'urgence...');
                
                // Hide loading after a short delay to ensure DOM is ready
                setTimeout(() => {
                    // Initialize emergency map
                    emergencyMap = L.map('emergency-map', {
                        zoomControl: true,
                        attributionControl: false,
                        preferCanvas: true
                    }).setView([48.8566, 2.3522], 14);

                    // Add satellite layer
                    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        maxZoom: 19,
                        attribution: ''
                    });
                    satelliteLayer.addTo(emergencyMap);

                    // Add street overlay for labels
                    const labelsLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
                        maxZoom: 19,
                        opacity: 0.8,
                        attribution: ''
                    });
                    labelsLayer.addTo(emergencyMap);

                    // Wait for tiles to load before adding markers
                    emergencyMap.whenReady(() => {
                        console.log('Carte d\'urgence pr√™te, ajout des marqueurs...');
                        
                        // Hide loading indicator
                        if (loadingDiv) {
                            loadingDiv.style.display = 'none';
                        }
                        
                        // Add all children to emergency map
                        addChildrenToEmergencyMap();

                        // Update location info
                        updateEmergencyLocationInfo();

                        // Force map resize
                        setTimeout(() => {
                            emergencyMap.invalidateSize();
                        }, 100);
                    });

                    // Auto-refresh every 3 seconds to sync with main map
                    setInterval(() => {
                        const alertsPage = document.getElementById('alerts-page');
                        if (alertsPage && alertsPage.style.display !== 'none') {
                            // Sync positions from main tracking system
                            syncEmergencyMapWithMainMap();
                            updateEmergencyMap();
                        }
                    }, 3000);

                }, 500);

            } catch (error) {
                console.error('Erreur initialisation carte d\'urgence:', error);
                if (loadingDiv) {
                    loadingDiv.innerHTML = '<div style="color: #dc3545; text-align: center;"><i class="fas fa-exclamation-triangle"></i><br>Erreur de chargement</div>';
                }
                const locationText = document.getElementById('emergency-location-text');
                if (locationText) {
                    locationText.textContent = 'Erreur de chargement de la carte';
                }
            }
        }

        function addChildrenToEmergencyMap() {
            if (!emergencyMap) return;

            const createEmergencyIcon = (color, letter, isAlert = false) => {
                const alertClass = isAlert ? 'emergency-alert-pulse' : '';
                return L.divIcon({
                    className: 'emergency-marker',
                    html: `<div style="position: relative; width: 50px; height: 50px;">
                             ${isAlert ? `<div class="${alertClass}" style="background: ${color}; border-color: ${color};"></div>` : ''}
                             <img src="https://res.cloudinary.com/dxy0fiahv/image/upload/v1756139122/logo_tfinds_laf9do.png" 
                                  style="width: 50px; height: 50px; border-radius: 50%; border: 4px solid ${color}; box-shadow: 0 4px 15px rgba(0,0,0,0.4); position: relative; z-index: 10;">
                             <div style="position: absolute; bottom: -8px; right: -8px; background: ${color}; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; border: 3px solid white; z-index: 11;">${letter}</div>
                           </div>`,
                    iconSize: [50, 50],
                    iconAnchor: [25, 25]
                });
            };

            Object.keys(childrenData).forEach(childId => {
                const child = childrenData[childId];
                const colors = {
                    emma: '#dc3545',  // Red for emergency
                    lucas: '#28a745', 
                    sarah: '#17a2b8'
                };
                const letters = {
                    emma: 'E',
                    lucas: 'L',
                    sarah: 'S'
                };

                // Emma has emergency alert
                const isEmergency = childId === 'emma';
                
                const marker = L.marker([child.lat, child.lng], {
                    icon: createEmergencyIcon(colors[childId], letters[childId], isEmergency)
                }).addTo(emergencyMap);

                const popupContent = `
                    <div style="text-align: center; min-width: 200px;">
                        <h4 style="color: ${colors[childId]}; margin-bottom: 0.5rem;">
                            ${childId.charAt(0).toUpperCase() + childId.slice(1)}
                            ${isEmergency ? ' üö®' : ''}
                        </h4>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>${child.status}</strong>
                        </div>
                        <div style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
                            üìç Pr√©cision: ¬±${child.accuracy}m<br>
                            ‚è∞ ${child.lastUpdate.toLocaleTimeString()}
                            ${isEmergency ? '<br><span style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è ALERTE ACTIVE</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button class="btn btn-primary" onclick="callChild('${childId}')" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                <i class="fas fa-phone"></i> Appeler
                            </button>
                            <button class="btn btn-info" onclick="sendMessage('${childId}')" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                <i class="fas fa-comment"></i> Message
                            </button>
                        </div>
                    </div>
                `;
                marker.bindPopup(popupContent);
                emergencyMarkers[childId] = marker;
            });

            // Center map on all children
            const group = new L.featureGroup(Object.values(emergencyMarkers));
            emergencyMap.fitBounds(group.getBounds().pad(0.1));
        }

        function updateEmergencyMap() {
            if (!emergencyMap || !emergencyMarkers) return;

            Object.keys(childrenData).forEach(childId => {
                const child = childrenData[childId];
                if (emergencyMarkers[childId]) {
                    // Use the real-time updated positions from the main tracking system
                    emergencyMarkers[childId].setLatLng([child.lat, child.lng]);
                    
                    // Update popup content with current data
                    const colors = {
                        emma: '#dc3545',
                        lucas: '#28a745', 
                        sarah: '#17a2b8'
                    };
                    
                    const isEmergency = childId === 'emma';
                    const popupContent = `
                        <div style="text-align: center; min-width: 200px;">
                            <h4 style="color: ${colors[childId]}; margin-bottom: 0.5rem;">
                                ${childId.charAt(0).toUpperCase() + childId.slice(1)}
                                ${isEmergency ? ' üö®' : ''}
                            </h4>
                            <div style="margin-bottom: 0.5rem;">
                                <strong>${child.status}</strong>
                            </div>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
                                üìç Position: ${child.lat.toFixed(6)}, ${child.lng.toFixed(6)}<br>
                                üéØ Pr√©cision: ¬±${child.accuracy}m<br>
                                ‚è∞ ${child.lastUpdate.toLocaleTimeString()}
                                ${isEmergency ? '<br><span style="color: #dc3545; font-weight: bold;">‚ö†Ô∏è ALERTE ACTIVE</span>' : ''}
                            </div>
                            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                <button class="btn btn-primary" onclick="callChild('${childId}')" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                    <i class="fas fa-phone"></i> Appeler
                                </button>
                                <button class="btn btn-info" onclick="sendMessage('${childId}')" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                                    <i class="fas fa-comment"></i> Message
                                </button>
                            </div>
                        </div>
                    `;
                    emergencyMarkers[childId].setPopupContent(popupContent);
                }
            });

            updateEmergencyLocationInfo();
        }

        function updateEmergencyLocationInfo() {
            const locationText = document.getElementById('emergency-location-text');
            if (!locationText) return;

            const activeAlerts = Object.keys(childrenData).filter(childId => childId === 'emma').length;
            const totalChildren = Object.keys(childrenData).length;
            
            locationText.innerHTML = `
                üö® ${activeAlerts} alerte${activeAlerts > 1 ? 's' : ''} active${activeAlerts > 1 ? 's' : ''} 
                ‚Ä¢ ${totalChildren} enfant${totalChildren > 1 ? 's' : ''} surveill√©${totalChildren > 1 ? 's' : ''}
                ‚Ä¢ Mise √† jour: ${new Date().toLocaleTimeString()}
            `;
        }

        function refreshEmergencyMap() {
            if (emergencyMap) {
                updateEmergencyMap();
                showNotification('üîÑ Carte d\'urgence actualis√©e', 'info');
            } else {
                // Force reinitialize if map doesn't exist
                console.log('R√©initialisation forc√©e de la carte d\'urgence');
                window.emergencyMapInitialized = false;
                emergencyMap = null;
                emergencyMarkers = {};
                
                setTimeout(() => {
                    initializeEmergencyMap();
                    window.emergencyMapInitialized = true;
                }, 100);
            }
        }

        function callChild(childId) {
            const phones = {
                emma: '+33 6 11 22 33 44',
                lucas: '+33 6 55 66 77 88', 
                sarah: '+33 6 99 00 11 22'
            };
            
            if (confirm(`Appeler ${childId.charAt(0).toUpperCase() + childId.slice(1)} ?`)) {
                window.location.href = `tel:${phones[childId]}`;
                showNotification(`üìû Appel vers ${childId.charAt(0).toUpperCase() + childId.slice(1)}`, 'info');
            }
        }

        function sendMessage(childId) {
            const message = prompt(`Message pour ${childId.charAt(0).toUpperCase() + childId.slice(1)}:`);
            if (message) {
                showNotification(`üí¨ Message envoy√© √† ${childId.charAt(0).toUpperCase() + childId.slice(1)}`, 'success');
            }
        }

        // High-precision location tracking with pulse effect
        function startHighPrecisionTracking() {
            if (!navigator.geolocation) {
                console.error('G√©olocalisation non support√©e');
                return;
            }

            // Stop existing tracking
            if (mapWatchId) {
                navigator.geolocation.clearWatch(mapWatchId);
            }

            // Ultra high precision options for 2m accuracy
            const options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0, // Force fresh location
                desiredAccuracy: 2 // Target 2 meters precision
            };

            mapWatchId = navigator.geolocation.watchPosition(
                function(position) {
                    updateUserLocationOnMap(position);
                },
                function(error) {
                    console.error('Erreur de g√©olocalisation:', error);
                    handleLocationError(error);
                },
                options
            );
        }

        function updateUserLocationOnMap(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            // Center map on first location
            if (!userMarker) {
                map.setView([lat, lng], 18);
            }

            // Remove existing markers and effects
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            if (userAccuracyCircle) {
                map.removeLayer(userAccuracyCircle);
            }
            if (userPulseEffect) {
                map.removeLayer(userPulseEffect);
            }

            // Create accuracy circle
            userAccuracyCircle = L.circle([lat, lng], {
                radius: accuracy,
                className: 'accuracy-circle',
                fillOpacity: 0.1,
                weight: 2
            }).addTo(map);

            // Create main user marker with logo and pulse effect combined
            userMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'user-marker-container',
                    html: `
                        <div class="user-location-pulse"></div>
                        <img src="https://res.cloudinary.com/dxy0fiahv/image/upload/v1756139122/logo_tfinds_laf9do.png" 
                             style="width: 32px; height: 32px; border-radius: 50%; border: 3px solid #007bff; box-shadow: 0 2px 8px rgba(0,0,0,0.4); position: relative; z-index: 10;">
                    `,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                }),
                zIndexOffset: 2000
            }).addTo(map);

            // Update popup with precision info
            const popupContent = `
                <b>üéØ Votre position exacte</b><br>
                <small>üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}</small><br>
                <small>üéØ Pr√©cision: ¬±${Math.round(accuracy)}m</small><br>
                <small>‚è∞ ${new Date().toLocaleTimeString()}</small>
            `;
            userMarker.bindPopup(popupContent);

            // Update location display
            updateLocationDisplayWithCoords(lat, lng, accuracy);
        }

        async function updateLocationDisplayWithCoords(lat, lng, accuracy) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                const address = data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                
                const locationText = document.getElementById('location-text');
                if (locationText) {
                    locationText.innerHTML = `
                        üìç ${address.split(',').slice(0, 2).join(', ')}<br>
                        <small>üéØ Pr√©cision: ¬±${Math.round(accuracy)}m</small>
                    `;
                }
            } catch (error) {
                const locationText = document.getElementById('location-text');
                if (locationText) {
                    locationText.innerHTML = `
                        üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
                        <small>üéØ Pr√©cision: ¬±${Math.round(accuracy)}m</small>
                    `;
                }
            }
        }

        function handleLocationError(error) {
            let message = 'Erreur de localisation';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Acc√®s √† la localisation refus√©';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Position indisponible';
                    break;
                case error.TIMEOUT:
                    message = 'D√©lai de localisation d√©pass√©';
                    break;
            }
            
            const locationText = document.getElementById('location-text');
            if (locationText) {
                locationText.textContent = `‚ö†Ô∏è ${message}`;
            }
        }

        function updateLocationDisplay() {
            // This function is kept for compatibility but now handled by high-precision tracking
            if (userPosition) {
                updateLocationDisplayWithCoords(userPosition.lat, userPosition.lng, userPosition.accuracy);
            }
        }

        async function myLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        const timestamp = new Date(position.timestamp);
                        
                        // Get readable address
                        let addressText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=fr`);
                            if (response.ok) {
                                const data = await response.json();
                                if (data.display_name) {
                                    addressText = data.display_name;
                                }
                            }
                        } catch (error) {
                            console.log('Reverse geocoding failed');
                        }
                        
                        // Update map center info
                        const locationTextElement = document.getElementById('location-text');
                        if (locationTextElement) {
                            locationTextElement.textContent = `${addressText} - Pr√©cision: ${Math.round(accuracy)}m - ${timestamp.toLocaleTimeString()}`;
                        }
                        
                        alert(`üìç Position obtenue avec succ√®s !\n\nüìç Adresse: ${addressText}\n\nüéØ Coordonn√©es exactes:\nLatitude: ${lat.toFixed(8)}\nLongitude: ${lng.toFixed(8)}\n\nüìä Pr√©cision: ${Math.round(accuracy)} m√®tres\n‚è∞ Heure: ${timestamp.toLocaleTimeString()}\n\nLa carte affiche maintenant votre position r√©elle.`);
                    },
                    function(error) {
                        let errorMessage = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Acc√®s √† la g√©olocalisation refus√©.\n\nüîß Solution: Cliquez sur l\'ic√¥ne de localisation dans la barre d\'adresse et autorisez l\'acc√®s.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Position indisponible.\n\nüîß Solutions:\n‚Ä¢ Activez le GPS sur votre appareil\n‚Ä¢ V√©rifiez votre connexion internet\n‚Ä¢ Sortez √† l\'ext√©rieur pour un meilleur signal';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'D√©lai d\'attente d√©pass√©.\n\nüîß Solution: R√©essayez, le GPS peut prendre du temps √† se connecter.';
                                break;
                            default:
                                errorMessage = 'Erreur inconnue lors de la g√©olocalisation.';
                                break;
                        }
                        alert(`‚ùå Erreur de g√©olocalisation\n\n${errorMessage}`);
                        
                        // Update with error message
                        const locationTextElement = document.getElementById('location-text');
                        if (locationTextElement) {
                            locationTextElement.textContent = 'Erreur de g√©olocalisation - Cliquez pour r√©essayer';
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 30000
                    }
                );
            } else {
                alert('‚ùå G√©olocalisation non support√©e\n\nVotre navigateur ne supporte pas la g√©olocalisation HTML5.');
            }
        }

        function showChildInfo(childName) {
            const children = {
                'emma': 'Emma - √Ä l\'√©cole\nüìç √âcole Primaire Terrano\nüîã Batterie: 87%\nüì∂ Signal: Excellent\n‚è∞ Derni√®re position: il y a 1 min',
                'lucas': 'Lucas - √Ä la maison\nüìç Rue des Lilas\nüîã Batterie: 34%\nüì∂ Signal: Bon\n‚è∞ Derni√®re position: il y a 3 min',
                'sarah': 'Sarah - Chez Grand-m√®re\nüìç Rue du Bonheur\nüîã Batterie: 92%\nüì∂ Signal: Moyen\n‚è∞ Derni√®re position: il y a 5 min'
            };
            alert(`‚ÑπÔ∏è Informations d√©taill√©es\n\n${children[childName]}`);
        }

        function trackChild(childName) {
            alert(`üéØ Suivi de ${childName.charAt(0).toUpperCase() + childName.slice(1)}\n\nLa carte est maintenant centr√©e sur la position de votre enfant.`);
        }

        function messageChild(childName) {
            const message = prompt(`üí¨ Envoyer un message √† ${childName.charAt(0).toUpperCase() + childName.slice(1)}:`, 'Salut ! Comment √ßa va ?');
            if (message) {
                alert(`‚úÖ Message envoy√© √† ${childName.charAt(0).toUpperCase() + childName.slice(1)} !\n\n"${message}"`);
            }
        }

        // Zone management functions
        function addZone() {
            const name = document.getElementById('zone-name').value;
            const type = document.getElementById('zone-type').value;
            const address = document.getElementById('zone-address').value;
            const radius = document.getElementById('zone-radius').value;

            if (!name || !type || !address) {
                alert('Veuillez remplir tous les champs obligatoires.');
                return;
            }

            alert(`‚úÖ Zone s√ªre cr√©√©e avec succ√®s !\n\nNom: ${name}\nType: ${type}\nAdresse: ${address}\nRayon: ${radius}m\n\nLa zone est maintenant active et surveill√©e.`);
            
            // Clear form
            document.getElementById('zone-name').value = '';
            document.getElementById('zone-type').value = '';
            document.getElementById('zone-address').value = '';
            document.getElementById('zone-radius').value = '100';
        }

        function editZone(zoneId) {
            alert(`üîß Modification de la zone "${zoneId}"\n\nNote: Dans une vraie application, ceci ouvrirait un formulaire d'√©dition avec les param√®tres actuels de la zone.`);
        }

        function deleteZone(zoneId) {
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer cette zone s√ªre ?\n\nCette action est irr√©versible.`)) {
                alert(`üóëÔ∏è Zone "${zoneId}" supprim√©e avec succ√®s !\n\nLa surveillance de cette zone a √©t√© d√©sactiv√©e.`);
            }
        }

        function locateMe() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        
                        // Auto-fill address field with coordinates
                        const addressField = document.getElementById('zone-address');
                        if (addressField) {
                            addressField.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        }
                        
                        alert(`üìç Position obtenue avec succ√®s !\n\nLatitude: ${lat.toFixed(6)}\nLongitude: ${lng.toFixed(6)}\nPr√©cision: ${Math.round(accuracy)} m√®tres\n\nLes coordonn√©es ont √©t√© ajout√©es au champ adresse.`);
                    },
                    function(error) {
                        let errorMessage = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Acc√®s √† la g√©olocalisation refus√©.\nVeuillez autoriser l\'acc√®s √† votre position.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Position indisponible.\nV√©rifiez votre connexion GPS/WiFi.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'D√©lai d\'attente d√©pass√©.';
                                break;
                            default:
                                errorMessage = 'Erreur inconnue lors de la g√©olocalisation.';
                                break;
                        }
                        alert(`‚ùå Erreur de g√©olocalisation\n\n${errorMessage}`);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                alert('‚ùå G√©olocalisation non support√©e\n\nVotre navigateur ne supporte pas la g√©olocalisation HTML5.');
            }
        }

        // Legacy contact functions (kept for compatibility)
        function callContact(phone) {
            showNotification(`üìû Appel vers ${phone}`, 'info');
            window.location.href = `tel:${phone}`;
        }

        // Premium upgrade
        function upgradeToPremium() {
            if (confirm('Passer √† TerranoKidsFind Premium pour 9,99‚Ç¨/mois ?\n\n‚úì 7 jours d\'essai gratuit\n‚úì Annulation √† tout moment\n‚úì Toutes les fonctionnalit√©s premium')) {
                alert('üéâ Bienvenue dans TerranoKidsFind Premium !\n\nVotre p√©riode d\'essai de 7 jours commence maintenant.\nToutes les fonctionnalit√©s premium sont d√©sormais disponibles.');
                
                // Update plan status
                const planCard = document.querySelector('#premium-page .card');
                if (planCard) {
                    planCard.innerHTML = `
                        <div class="card-header">
                            <h3 class="card-title">Plan Actuel : Premium</h3>
                            <span style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem;">
                                <i class="fas fa-crown"></i> Actif
                            </span>
                        </div>
                        <p>üéâ F√©licitations ! Vous b√©n√©ficiez maintenant de toutes les fonctionnalit√©s premium.</p>
                        <div style="margin-top: 1rem;">
                            <strong>Votre essai gratuit :</strong>
                            <ul style="margin-left: 2rem; margin-top: 0.5rem;">
                                <li>6 jours restants</li>
                                <li>Acc√®s complet aux fonctionnalit√©s</li>
                                <li>Support prioritaire 24/7</li>
                                <li>Annulation possible √† tout moment</li>
                            </ul>
                        </div>
                    `;
                }
            }
        }

        // Real-time location tracking
        let userPosition = null;

        function startLocationTracking() {
            if (navigator.geolocation) {
                mapWatchId = navigator.geolocation.watchPosition(
                    function(position) {
                        userPosition = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date(position.timestamp)
                        };
                        
                        // Update all location displays
                        updateLocationDisplays();
                    },
                    function(error) {
                        console.error('Erreur de g√©olocalisation:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 30000,
                        maximumAge: 10000
                    }
                );
            }
        }

        function stopLocationTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
        }

        async function updateLocationDisplays() {
            if (!userPosition) return;

            // Get address from coordinates using reverse geocoding
            let locationText = `Position: ${userPosition.lat.toFixed(6)}, ${userPosition.lng.toFixed(6)} - Pr√©cision: ${Math.round(userPosition.accuracy)}m`;
            
            try {
                // Try to get readable address
                const response = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${userPosition.lat}+${userPosition.lng}&key=demo&language=fr&pretty=1&no_annotations=1`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        const address = data.results[0].formatted;
                        locationText = `${address} - Pr√©cision: ${Math.round(userPosition.accuracy)}m - ${userPosition.timestamp.toLocaleTimeString()}`;
                    }
                }
            } catch (error) {
                console.log('Reverse geocoding failed, using coordinates');
            }

            // Update map info
            const locationTextElement = document.getElementById('location-text');
            if (locationTextElement) {
                locationTextElement.textContent = locationText;
            }

            // Update dashboard location status
            const locationCards = document.querySelectorAll('.status-card');
            locationCards.forEach(card => {
                if (card.querySelector('.status-label')?.textContent.includes('GPS') || card.querySelector('.status-label')?.textContent.includes('Pr√©cision')) {
                    card.querySelector('.status-value').textContent = `${Math.round(userPosition.accuracy)}m`;
                    card.querySelector('.status-label').textContent = 'Pr√©cision GPS';
                }
            });
        }

        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    // Fallback: utiliser une position simul√©e
                    console.warn('G√©olocalisation non support√©e, utilisation d\'une position simul√©e');
                    resolve({
                        coords: {
                            latitude: 48.8566,
                            longitude: 2.3522,
                            accuracy: 100
                        },
                        timestamp: Date.now()
                    });
                    return;
                }

                // Essayer d'abord avec les permissions relax√©es pour file://
                const options = {
                    enableHighAccuracy: false, // Moins strict pour file://
                    timeout: 15000,
                    maximumAge: 300000 // Cache plus long
                };

                navigator.geolocation.getCurrentPosition(
                    resolve,
                    function(error) {
                        console.warn('G√©olocalisation √©chou√©e, utilisation d\'une position simul√©e:', error.message);
                        // Fallback vers position simul√©e
                        resolve({
                            coords: {
                                latitude: 48.8566 + (Math.random() - 0.5) * 0.01,
                                longitude: 2.3522 + (Math.random() - 0.5) * 0.01,
                                accuracy: 1000
                            },
                            timestamp: Date.now(),
                            simulated: true
                        });
                    },
                    options
                );
            });
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            showPage('dashboard');
            startLocationTracking();
            
            // Initialize emergency contacts
            refreshEmergencyContacts();
            
            // Initialize zones list
            refreshZonesList();
            
            // Initialize contacts list
            refreshContactsList();
            
            // Initialize message history
            initializeMessageHistory();
            
            // Add click handlers for SOS buttons
            const sosButtons = document.querySelectorAll('.sos-trigger');
            sosButtons.forEach(btn => {
                btn.addEventListener('click', triggerSOS);
            });
            
            // Handle hash navigation
            function handleHashNavigation() {
                const hash = window.location.hash.substring(1);
                if (hash && document.getElementById(hash + '-page')) {
                    showPage(hash);
                }
            }
            
            // Listen for hash changes
            window.addEventListener('hashchange', handleHashNavigation);
            
            // Handle initial hash
            handleHashNavigation();
            
            // Form validation and feedback
            function validateForm(formElement) {
                const inputs = formElement.querySelectorAll('input[required], select[required]');
                let isValid = true;
                
                inputs.forEach(input => {
                    if (!input.value.trim()) {
                        showFieldError(input, 'Ce champ est obligatoire');
                        isValid = false;
                    } else if (input.pattern && !new RegExp(input.pattern).test(input.value)) {
                        showFieldError(input, 'Format invalide');
                        isValid = false;
                    } else {
                        clearFieldError(input);
                    }
                });
                
                return isValid;
            }
            
            function showFieldError(input, message) {
                clearFieldError(input);
                input.style.borderColor = 'var(--error)';
                input.setAttribute('aria-invalid', 'true');
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'field-error';
                errorDiv.id = input.id + '-error';
                errorDiv.setAttribute('role', 'alert');
                errorDiv.style.cssText = 'color: var(--error); font-size: 0.8rem; margin-top: 0.25rem;';
                errorDiv.textContent = message;
                
                input.setAttribute('aria-describedby', errorDiv.id);
                input.parentNode.appendChild(errorDiv);
            }
            
            function clearFieldError(input) {
                input.style.borderColor = '#ddd';
                input.setAttribute('aria-invalid', 'false');
                input.removeAttribute('aria-describedby');
                
                const existingError = input.parentNode.querySelector('.field-error');
                if (existingError) {
                    existingError.remove();
                }
            }

            // Initialize everything when DOM is loaded
            refreshEmergencyContacts();
            refreshZonesList();
            refreshContactsList();
            initializeMessageHistory();
            
            // Initialize SOS button event listener
            const sosButton = document.getElementById('sos-button');
            if (sosButton) {
                sosButton.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        triggerSOS();
                    }
                });
            }
            
            // Add form validation to all forms
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    if (!validateForm(form)) {
                        e.preventDefault();
                        showNotification('‚ùå Veuillez corriger les erreurs dans le formulaire', 'error');
                    }
                });
                
                // Real-time validation
                const inputs = form.querySelectorAll('input, select');
                inputs.forEach(input => {
                    input.addEventListener('blur', function() {
                        if (input.hasAttribute('required') || input.value.trim()) {
                            if (!input.value.trim()) {
                                showFieldError(input, 'Ce champ est obligatoire');
                            } else if (input.pattern && !new RegExp(input.pattern).test(input.value)) {
                                showFieldError(input, 'Format invalide');
                            } else {
                                clearFieldError(input);
                            }
                        }
                    });
                });
            });
            
            // Request location permission on load
            if (navigator.geolocation) {
                getCurrentLocation().then(position => {
                    console.log('Position initiale obtenue:', position);
                }).catch(error => {
                    console.warn('Impossible d\'obtenir la position initiale:', error);
                });
            }
        });
    </script>
</body>
</html>
